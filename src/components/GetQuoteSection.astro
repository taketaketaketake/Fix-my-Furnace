---
/**
 * GetQuoteSection.astro
 * Two-sided section: quote form on the left, bold About text on the right.
 * Designed with contrast and modern industrial tone.
 */

const MAPBOX_TOKEN = import.meta.env.PUBLIC_MAPBOX_TOKEN;
---

<section class="relative bg-gradient-to-r from-gray-50 to-white border-t border-gray-200 pt-10 pb-10 px-6 md:px-10">
  <div
    class="max-w-7xl mx-auto grid md:grid-cols-2 gap-12 md:gap-16 items-center"
  >
    <!-- ðŸ”´ Left Side: Lead Form -->
    <div
      class="bg-white border border-gray-200 shadow-lg rounded-2xl p-8 md:p-10 flex flex-col justify-center"
    >
      <h3 class="text-3xl font-bold text-gray-900 mb-4">
        Get Your Furnace Fixed Fast
      </h3>
      <p class="text-gray-600 mb-6 text-sm md:text-base">
        Fill out this form â€” a local HVAC expert will call you
        back right away.
      </p>

      <!-- Success/Error Message Container -->
      <div id="quoteFormMessages" class="mb-6 hidden">
        <div id="quoteSuccessMessage" class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4 hidden">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
            </svg>
            <p class="text-green-800 font-semibold">Quote request sent! We'll call you shortly.</p>
          </div>
        </div>
        
        <div id="quoteErrorMessage" class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 hidden">
          <div class="flex items-center">
            <svg class="w-5 h-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
              <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
            </svg>
            <p class="text-red-800 font-semibold">Something went wrong. Please try again or call us directly.</p>
          </div>
        </div>

        <div id="quoteLoadingMessage" class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 hidden">
          <div class="flex items-center">
            <svg class="animate-spin w-5 h-5 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="text-blue-800 font-semibold">Sending your quote request...</p>
          </div>
        </div>
      </div>

      <form class="space-y-4" id="quoteForm">
        <!-- Hidden honeypot field for spam protection -->
        <div style="display: none;">
          <label>Don't fill this out if you're human: <input name="bot-field" /></label>
        </div>
        
        <!-- ðŸ§ Name -->
        <div>
          <label for="name" class="block text-sm font-semibold text-gray-800">
            Name
          </label>
          <input
            id="name"
            name="name"
            type="text"
            placeholder="John Doe"
            class="mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
            required
          />
        </div>

        <!-- â˜Žï¸ Phone -->
        <div>
          <label for="phone" class="block text-sm font-semibold text-gray-800">
            Phone Number
          </label>
          <input
            id="phone"
            name="phone"
            type="tel"
            placeholder="(313) 555-1234"
            maxlength="14"
            class="mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
            required
          />
          <div id="phoneError" class="text-red-600 text-sm mt-1 hidden">Please enter a valid phone number</div>
        </div>

        <!-- ðŸ“ Address -->
        <div>
          <label for="address" class="block text-sm font-semibold text-gray-800">
            Address
          </label>
          <div class="relative">
            <input
              id="address"
              name="address"
              type="text"
              placeholder="Enter your full address"
              class="mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
              autocomplete="off"
              required
            />
            <!-- Address suggestions dropdown -->
            <div id="addressSuggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
            </div>
          </div>
        </div>

        <!-- âš™ï¸ Issue Dropdown -->
        <div>
          <label for="issue" class="block text-sm font-semibold text-gray-800">
            Whatâ€™s happening with your furnace?
          </label>
          <select
            id="issue"
            name="issue"
            class="mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
            required
          >
            <option value="">Select an issue...</option>
            <option value="no-power">It wonâ€™t turn on</option>
            <option value="cold-air">Itâ€™s blowing cold air</option>
            <option value="noises">Itâ€™s making strange noises</option>
            <option value="old">Itâ€™s old and unreliable</option>
            <option value="checkup">Not sure / want a check-up</option>
          </select>
        </div>

        <!-- ðŸš€ Submit -->
        <button
          type="submit"
          id="quoteSubmitBtn"
          class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-red-700 active:scale-[0.98] transition disabled:opacity-50 disabled:cursor-not-allowed"
        >
          <span id="quoteSubmitText">Get a Free Quote</span>
          <span id="quoteSubmitLoading" class="hidden">
            <svg class="animate-spin inline w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Sending...
          </span>
        </button>
      </form>

      <p class="text-xs text-gray-500 mt-4 text-center">
        By submitting this form, you agree to be contacted by Fix My Furnace or
        its partners for scheduling and service information.
      </p>
    </div>

    <!-- âš™ï¸ Right Side: About Us -->
    <div class="flex flex-col justify-center text-left md:pl-6 lg:pl-10">
      <h2
        class="text-4xl md:text-5xl font-extrabold text-gray-900 leading-tight mb-6"
      >
        Built on <span class="text-red-600">Trust, Speed,</span><br />
        and <span class="underline decoration-red-500">Real Detroit Grit.</span>
      </h2>

      <p class="text-gray-700 text-lg md:text-xl font-semibold mb-6">
        Weâ€™re not a call center â€” weâ€™re your local HVAC pros. When your furnace
        breaks, we move fast, work clean, and donâ€™t leave you guessing. Every
        job is done with care, precision, and old-school craftsmanship.
      </p>

      <div class="mt-6 flex flex-col sm:flex-row gap-4">
        <a
          href="/about"
          class="inline-block px-6 py-3 font-bold bg-red-600 text-white rounded-lg hover:bg-red-700 transition"
        >
          Learn More
        </a>
        <a
          href="/contact"
          class="inline-block px-6 py-3 font-bold border-2 border-gray-900 text-gray-900 rounded-lg hover:bg-gray-900 hover:text-white transition"
        >
          Contact Us
        </a>
      </div>
    </div>
  </div>
</section>

<!-- Mapbox Geocoding API -->
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

<script type="module" define:vars={{ MAPBOX_TOKEN }}>
  
  document.addEventListener("DOMContentLoaded", () => {
    // API endpoint for form submission
    const API_ENDPOINT = '/api/send-verification';
    
    // Quote form handling
    const quoteForm = document.getElementById('quoteForm');
    const quoteSubmitBtn = document.getElementById('quoteSubmitBtn');
    const quoteSubmitText = document.getElementById('quoteSubmitText');
    const quoteSubmitLoading = document.getElementById('quoteSubmitLoading');
    const quoteFormMessages = document.getElementById('quoteFormMessages');
    const quoteSuccessMessage = document.getElementById('quoteSuccessMessage');
    const quoteErrorMessage = document.getElementById('quoteErrorMessage');
    const quoteLoadingMessage = document.getElementById('quoteLoadingMessage');
    
    // Phone input handling
    const phoneInput = document.getElementById('phone');
    const phoneError = document.getElementById('phoneError');
    
    // Address autocomplete elements
    const addressInput = document.getElementById('address');
    const addressSuggestions = document.getElementById('addressSuggestions');

    if (!quoteForm) return; // Exit if form not found

    // Phone number formatting and validation
    function formatPhoneNumber(value) {
      const phone = value.replace(/\D/g, '');
      if (phone.length < 4) return phone;
      if (phone.length < 7) return `(${phone.slice(0,3)}) ${phone.slice(3)}`;
      return `(${phone.slice(0,3)}) ${phone.slice(3,6)}-${phone.slice(6,10)}`;
    }

    function validatePhoneNumber(phone) {
      const digits = phone.replace(/\D/g, '');
      return digits.length === 10;
    }

    function showPhoneError(show) {
      if (show) {
        phoneInput.classList.add('border-red-500');
        phoneError.classList.remove('hidden');
      } else {
        phoneInput.classList.remove('border-red-500');
        phoneError.classList.add('hidden');
      }
    }

    // Phone input event listeners
    if (phoneInput) {
      phoneInput.addEventListener('input', (e) => {
        const formatted = formatPhoneNumber(e.target.value);
        e.target.value = formatted;
        
        if (formatted.length > 0) {
          const isValid = validatePhoneNumber(formatted);
          showPhoneError(!isValid);
        } else {
          showPhoneError(false);
        }
      });

      phoneInput.addEventListener('keydown', (e) => {
        // Allow backspace, delete, tab, escape, enter
        if ([8, 9, 27, 13, 46].includes(e.keyCode) ||
            // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
            (e.keyCode === 65 && e.ctrlKey) ||
            (e.keyCode === 67 && e.ctrlKey) ||
            (e.keyCode === 86 && e.ctrlKey) ||
            (e.keyCode === 88 && e.ctrlKey)) {
          return;
        }
        // Only allow numbers
        if ((e.keyCode < 48 || e.keyCode > 57) && (e.keyCode < 96 || e.keyCode > 105)) {
          e.preventDefault();
        }
      });
    }

    // Function to show specific message
    function showQuoteMessage(messageType) {
      // Hide all messages first
      quoteSuccessMessage.classList.add('hidden');
      quoteErrorMessage.classList.add('hidden');
      quoteLoadingMessage.classList.add('hidden');
      
      // Show container and specific message
      quoteFormMessages.classList.remove('hidden');
      document.getElementById('quote' + messageType.charAt(0).toUpperCase() + messageType.slice(1) + 'Message').classList.remove('hidden');
      
      // Scroll to message
      quoteFormMessages.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    // Function to hide all messages
    function hideQuoteMessages() {
      quoteFormMessages.classList.add('hidden');
      quoteSuccessMessage.classList.add('hidden');
      quoteErrorMessage.classList.add('hidden');
      quoteLoadingMessage.classList.add('hidden');
    }

    // Function to set loading state
    function setQuoteLoadingState(loading) {
      quoteSubmitBtn.disabled = loading;
      if (loading) {
        quoteSubmitText.classList.add('hidden');
        quoteSubmitLoading.classList.remove('hidden');
        showQuoteMessage('loading');
      } else {
        quoteSubmitText.classList.remove('hidden');
        quoteSubmitLoading.classList.add('hidden');
      }
    }

    // Address autocomplete functionality
    let debounceTimer;
    let selectedAddressIndex = -1;

    function searchAddresses(query) {
      if (query.length < 3) {
        addressSuggestions.classList.add('hidden');
        return;
      }

      // Debounce API calls
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        try {
          const response = await fetch(
            `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
            `access_token=${MAPBOX_TOKEN}&` +
            `country=US&` +
            `types=address&` +
            `limit=5&` +
            `bbox=-90.418,41.696,-82.413,48.2`  // Michigan bounding box
          );
          
          const data = await response.json();
          displayAddressSuggestions(data.features);
        } catch (error) {
          console.error('Error fetching addresses:', error);
        }
      }, 300);
    }

    function displayAddressSuggestions(addresses) {
      addressSuggestions.innerHTML = '';
      selectedAddressIndex = -1;

      if (addresses.length === 0) {
        addressSuggestions.classList.add('hidden');
        return;
      }

      addresses.forEach((address, index) => {
        const div = document.createElement('div');
        div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-b-0';
        div.textContent = address.place_name;
        div.addEventListener('click', () => selectAddress(address));
        addressSuggestions.appendChild(div);
      });

      addressSuggestions.classList.remove('hidden');
    }

    function selectAddress(address) {
      addressInput.value = address.place_name;
      addressSuggestions.classList.add('hidden');
      selectedAddressIndex = -1;
    }

    function updateSelectedSuggestion(suggestions) {
      suggestions.forEach((suggestion, index) => {
        if (index === selectedAddressIndex) {
          suggestion.classList.add('bg-red-100');
        } else {
          suggestion.classList.remove('bg-red-100');
        }
      });
    }

    // Address input event listeners
    if (addressInput && addressSuggestions) {
      addressInput.addEventListener('input', (e) => {
        searchAddresses(e.target.value);
      });

      addressInput.addEventListener('blur', () => {
        // Delay hiding to allow click events on suggestions
        setTimeout(() => {
          addressSuggestions.classList.add('hidden');
        }, 150);
      });

      addressInput.addEventListener('keydown', (e) => {
        const suggestions = addressSuggestions.querySelectorAll('div');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedAddressIndex = Math.min(selectedAddressIndex + 1, suggestions.length - 1);
          updateSelectedSuggestion(suggestions);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedAddressIndex = Math.max(selectedAddressIndex - 1, -1);
          updateSelectedSuggestion(suggestions);
        } else if (e.key === 'Enter' && selectedAddressIndex >= 0) {
          e.preventDefault();
          suggestions[selectedAddressIndex].click();
        } else if (e.key === 'Escape') {
          addressSuggestions.classList.add('hidden');
          selectedAddressIndex = -1;
        }
      });
    }

    // Handle form submission
    quoteForm.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      setQuoteLoadingState(true);
      
      try {
        // Get form data
        const formData = new FormData(quoteForm);
        const name = formData.get('name')?.trim();
        const phone = formData.get('phone')?.trim();
        const address = formData.get('address')?.trim();
        const issue = formData.get('issue')?.trim();
        
        // Basic validation
        if (!name || !phone || !address || !issue) {
          throw new Error('Please fill in all required fields');
        }

        // Validate phone number
        if (!validatePhoneNumber(phone)) {
          throw new Error('Please enter a valid phone number');
        }
        
        // Submit to API endpoint
        const response = await fetch(API_ENDPOINT, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            formData: {
              name: name,
              address: address,
              issue: issue
            },
            phoneNumber: phone,
            formSource: 'homepage_quote'
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to submit form');
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to submit form');
        }
        
        // Success
        setQuoteLoadingState(false);
        showQuoteMessage('success');
        quoteForm.reset(); // Clear form
        
        // Hide success message after 5 seconds
        setTimeout(() => hideQuoteMessages(), 5000);
        
      } catch (error) {
        console.error('Submission error:', error);
        setQuoteLoadingState(false);
        showQuoteMessage('error');
        
        // Hide error message after 7 seconds
        setTimeout(() => hideQuoteMessages(), 7000);
      }
    });
  });
</script>
