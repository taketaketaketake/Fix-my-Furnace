---
/**
 * UniversalForm.astro
 * Reusable form component with configurable fields
 *
 * Usage:
 * <UniversalForm
 *   formId="contact-form"
 *   formSource="/api/submit-form"
 *   title="Get In Touch"
 *   description="Fill out the form below"
 *   fields={[
 *     { name: 'name', type: 'text', label: 'Full Name', required: true },
 *     { name: 'phone', type: 'tel', label: 'Phone Number', required: true }
 *   ]}
 *   submitText="Submit"
 * />
 */

export interface Props {
  formId: string;
  formSource: string;
  apiEndpoint?: string;
  title?: string;
  description?: string;
  fields: FormField[];
  submitText?: string;
  className?: string;
}

interface FormField {
  name: string;
  type: 'text' | 'tel' | 'email' | 'textarea' | 'select' | 'address';
  label: string;
  placeholder?: string;
  required?: boolean;
  options?: string[];
  autoComplete?: string;
}

const {
  formId,
  formSource,
  apiEndpoint = "/api/submit-form",
  title,
  description,
  fields,
  submitText = "Submit",
  className = ""
} = Astro.props;

const MAPBOX_TOKEN = import.meta.env.PUBLIC_MAPBOX_TOKEN;
---

<div class={`universal-form ${className}`}>
  {title && (
    <h3 class="text-3xl font-bold text-gray-900 mb-4">
      {title}
    </h3>
  )}

  {description && (
    <p class="text-gray-600 mb-6 text-sm md:text-base">
      {description}
    </p>
  )}

  <!-- Success/Error Message Container -->
  <div id={`${formId}-messages`} class="mb-6 hidden">
    <div id={`${formId}-success`} class="bg-green-50 border border-green-200 rounded-lg p-4 mb-4 hidden">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-green-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
        </svg>
        <p class="text-green-800 font-semibold">Form submitted successfully! We'll contact you soon.</p>
      </div>
    </div>

    <div id={`${formId}-error`} class="bg-red-50 border border-red-200 rounded-lg p-4 mb-4 hidden">
      <div class="flex items-center">
        <svg class="w-5 h-5 text-red-600 mr-3" fill="currentColor" viewBox="0 0 20 20">
          <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"></path>
        </svg>
        <p class="text-red-800 font-semibold">Something went wrong. Please try again.</p>
      </div>
    </div>

    <div id={`${formId}-loading`} class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4 hidden">
      <div class="flex items-center">
        <svg class="animate-spin w-5 h-5 text-blue-600 mr-3" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        <p class="text-blue-800 font-semibold">Submitting your form...</p>
      </div>
    </div>
  </div>

  <form class="space-y-4" id={formId}>

    <!-- Hidden honeypot field for spam protection -->
    <div style="display: none;">
      <label>Don't fill this out if you're human: <input name="bot-field" /></label>
    </div>

    {fields.map((field) => (
      <div>
        <label for={`${formId}-${field.name}`} class="block text-sm font-semibold text-gray-800">
          {field.label}
          {field.required && <span class="text-red-500 ml-1">*</span>}
        </label>

        {field.type === 'text' && (
          <input
            id={`${formId}-${field.name}`}
            name={field.name}
            type="text"
            placeholder={field.placeholder}
            class="mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
            required={field.required}
            autocomplete={field.autoComplete}
          />
        )}

        {field.type === 'tel' && (
          <>
            <input
              id={`${formId}-${field.name}`}
              name={field.name}
              type="tel"
              placeholder={field.placeholder || "(313) 555-1234"}
              maxlength="14"
              class="mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
              required={field.required}
              autocomplete={field.autoComplete || "tel"}
            />
            <div id={`${formId}-${field.name}-error`} class="text-red-600 text-sm mt-1 hidden">Please enter a valid phone number</div>
          </>
        )}

        {field.type === 'email' && (
          <input
            id={`${formId}-${field.name}`}
            name={field.name}
            type="email"
            placeholder={field.placeholder}
            class="mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
            required={field.required}
            autocomplete={field.autoComplete || "email"}
          />
        )}

        {field.type === 'textarea' && (
          <textarea
            id={`${formId}-${field.name}`}
            name={field.name}
            placeholder={field.placeholder}
            rows="4"
            class="mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition resize-vertical"
            required={field.required}
          ></textarea>
        )}

        {field.type === 'select' && (
          <select
            id={`${formId}-${field.name}`}
            name={field.name}
            class="mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
            required={field.required}
          >
            <option value="">Select an option...</option>
            {field.options?.map((option) => (
              <option value={option.toLowerCase().replace(/\s+/g, '-')}>{option}</option>
            ))}
          </select>
        )}

        {field.type === 'address' && (
          <div class="relative">
            <input
              id={`${formId}-${field.name}`}
              name={field.name}
              type="text"
              placeholder={field.placeholder || "Enter your full address"}
              class="mt-1 w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
              autocomplete="off"
              required={field.required}
            />
            <!-- Address suggestions dropdown -->
            <div id={`${formId}-${field.name}-suggestions`} class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
            </div>
          </div>
        )}
      </div>
    ))}

    <!-- Submit Button -->
    <button
      type="submit"
      id={`${formId}-submit`}
      class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow-md hover:bg-red-700 active:scale-[0.98] transition disabled:opacity-50 disabled:cursor-not-allowed"
    >
      <span id={`${formId}-submit-text`}>{submitText}</span>
      <span id={`${formId}-submit-loading`} class="hidden">
        <svg class="animate-spin inline w-5 h-5 mr-2" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Submitting...
      </span>
    </button>
  </form>
</div>

<!-- Note: Address autocomplete uses Mapbox Geocoding API only, no map display needed -->

<!-- Initialize the form with inline script -->
<script is:inline define:vars={{ formId, formSource, apiEndpoint, fields, MAPBOX_TOKEN }}>
  // Universal Form Handler - Inline Implementation
  document.addEventListener("DOMContentLoaded", () => {
    const config = {
      formId: formId,
      formSource: formSource,
      fields: fields,
      MAPBOX_TOKEN: MAPBOX_TOKEN
    };

    // Phone number formatting and validation
    function formatPhoneNumber(value) {
      const phone = value.replace(/\D/g, '');
      if (phone.length < 4) return phone;
      if (phone.length < 7) return `(${phone.slice(0,3)}) ${phone.slice(3)}`;
      return `(${phone.slice(0,3)}) ${phone.slice(3,6)}-${phone.slice(6,10)}`;
    }

    function validatePhoneNumber(phone) {
      const digits = phone.replace(/\D/g, '');
      return digits.length === 10;
    }

    function showFieldError(fieldName, show) {
      const field = document.getElementById(`${formId}-${fieldName}`);
      const error = document.getElementById(`${formId}-${fieldName}-error`);
      if (field && error) {
        if (show) {
          field.classList.add('border-red-500');
          error.classList.remove('hidden');
        } else {
          field.classList.remove('border-red-500');
          error.classList.add('hidden');
        }
      }
    }

    // Setup phone fields
    fields.forEach(field => {
      if (field.type === 'tel') {
        const phoneInput = document.getElementById(`${formId}-${field.name}`);
        if (phoneInput) {
          phoneInput.addEventListener('input', (e) => {
            const formatted = formatPhoneNumber(e.target.value);
            e.target.value = formatted;

            if (formatted.length > 0) {
              const isValid = validatePhoneNumber(formatted);
              showFieldError(field.name, !isValid);
            } else {
              showFieldError(field.name, false);
            }
          });

          phoneInput.addEventListener('keydown', (e) => {
            // Allow backspace, delete, tab, escape, enter
            if ([8, 9, 27, 13, 46].includes(e.keyCode) ||
                // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey) ||
                (e.keyCode === 67 && e.ctrlKey) ||
                (e.keyCode === 86 && e.ctrlKey) ||
                (e.keyCode === 88 && e.ctrlKey)) {
              return;
            }
            // Only allow numbers
            if ((e.keyCode < 48 || e.keyCode > 57) && (e.keyCode < 96 || e.keyCode > 105)) {
              e.preventDefault();
            }
          });
        }
      }
    });

    // Setup address autocomplete with Mapbox
    fields.forEach(field => {
      if (field.type === 'address' && MAPBOX_TOKEN) {
        const addressInput = document.getElementById(`${formId}-${field.name}`);
        const suggestions = document.getElementById(`${formId}-${field.name}-suggestions`);

        if (addressInput && suggestions) {
          let debounceTimer;

          function searchAddresses(query) {
            if (query.length < 3) {
              suggestions.classList.add('hidden');
              return;
            }

            clearTimeout(debounceTimer);
            debounceTimer = setTimeout(async () => {
              try {
                const response = await fetch(
                  `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
                  `access_token=${MAPBOX_TOKEN}&` +
                  `country=US&` +
                  `types=address&` +
                  `limit=5&` +
                  `bbox=-90.418,41.696,-82.413,48.2`
                );

                const data = await response.json();
                displaySuggestions(data.features);
              } catch (error) {
                console.error('Error fetching addresses:', error);
              }
            }, 300);
          }

          function displaySuggestions(addresses) {
            suggestions.innerHTML = '';

            if (addresses.length === 0) {
              suggestions.classList.add('hidden');
              return;
            }

            addresses.forEach((address) => {
              const div = document.createElement('div');
              div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-b-0';
              div.textContent = address.place_name;
              div.addEventListener('click', () => {
                addressInput.value = address.place_name;
                suggestions.classList.add('hidden');
              });
              suggestions.appendChild(div);
            });

            suggestions.classList.remove('hidden');
          }

          addressInput.addEventListener('input', (e) => {
            searchAddresses(e.target.value);
          });

          addressInput.addEventListener('blur', () => {
            setTimeout(() => {
              suggestions.classList.add('hidden');
            }, 150);
          });
        }
      }
    });

    // Get form elements
    const form = document.getElementById(formId);
    const submitBtn = document.getElementById(`${formId}-submit`);
    const submitText = document.getElementById(`${formId}-submit-text`);
    const submitLoading = document.getElementById(`${formId}-submit-loading`);
    const messages = document.getElementById(`${formId}-messages`);
    const successMessage = document.getElementById(`${formId}-success`);
    const errorMessage = document.getElementById(`${formId}-error`);
    const loadingMessage = document.getElementById(`${formId}-loading`);

    if (!form) {
      console.error(`Form with ID "${formId}" not found`);
      return;
    }

    // Message handling
    function showMessage(type) {
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      loadingMessage.classList.add('hidden');

      messages.classList.remove('hidden');
      document.getElementById(`${formId}-${type}`).classList.remove('hidden');

      messages.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function hideMessages() {
      messages.classList.add('hidden');
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      loadingMessage.classList.add('hidden');
    }

    function setLoadingState(loading) {
      submitBtn.disabled = loading;
      if (loading) {
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
        showMessage('loading');
      } else {
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    }

    // Update error message text dynamically
    function showError(message) {
      const errorText = errorMessage.querySelector('p');
      if (errorText) {
        errorText.textContent = message;
      }
      showMessage('error');
    }

    // Form submission
    form.addEventListener('submit', async function(e) {
      e.preventDefault();

      setLoadingState(true);

      try {
        const formData = new FormData(form);
        const data = {};

        // Collect form data
        fields.forEach(field => {
          const value = formData.get(field.name)?.trim();
          if (value) {
            data[field.name] = value;
          }
        });


        // Basic validation
        const requiredFields = fields.filter(f => f.required);
        for (const field of requiredFields) {
          if (!data[field.name]) {
            throw new Error(`${field.label} is required`);
          }
        }

        // Validate phone numbers
        for (const field of fields) {
          if (field.type === 'tel' && data[field.name]) {
            if (!validatePhoneNumber(data[field.name])) {
              throw new Error('Please enter a valid phone number');
            }
          }
        }

        // Submit to API
        const response = await fetch(apiEndpoint, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            formData: data,
            formSource: formSource
          })
        });

        if (!response.ok) {
          const errorData = await response.json();

          // Handle CSRF errors specifically
          if (response.status === 403) {
            throw new Error('Security validation failed. Please refresh the page and try again.');
          }

          throw new Error(errorData.error || 'Failed to submit form');
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to submit form');
        }

        // Success
        setLoadingState(false);
        showMessage('success');
        form.reset();

        // Hide success message after 5 seconds
        setTimeout(() => hideMessages(), 5000);

      } catch (error) {
        console.error('Submission error:', error);
        setLoadingState(false);
        showError(error.message || 'Something went wrong. Please try again.');

        // Hide error message after 7 seconds
        setTimeout(() => hideMessages(), 7000);
      }
    });
  });
</script>
