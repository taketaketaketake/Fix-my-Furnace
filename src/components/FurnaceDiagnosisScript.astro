---
/**
 * FurnaceDiagnosisScript.astro
 * Contains all the JavaScript functionality for the furnace diagnosis page
 * including progressive CTA, exit intent, form handling, and photo upload
 */

const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const MAPBOX_TOKEN = import.meta.env.PUBLIC_MAPBOX_TOKEN;
---

<script is:inline define:vars={{ SUPABASE_URL, SUPABASE_ANON_KEY, MAPBOX_TOKEN }}>
  document.addEventListener('DOMContentLoaded', () => {
    // Enhanced CTA System
    const progressiveCTA = document.getElementById('progressive-cta');
    const exitIntentCTA = document.getElementById('exit-intent-cta');
    const ctaMainText = document.getElementById('cta-main-text');
    const socialProofText = document.getElementById('social-proof-text');
    const exitIntentText = document.getElementById('exit-intent-text');

    // Progressive CTA Messages
    const progressiveMessages = [
      'Get Free Analysis',
      'Upload 3 Photos Now',
      'Start Your Upload',
      'Complete Upload'
    ];

    // Social Proof Messages
    const socialProofMessages = [
      'Join 1,200+ homeowners who saved money',
      'Sarah from Ann Arbor just uploaded photos',
      'Mike from Detroit saved $150 today',
      '324 free diagnoses completed this week',
      'Emma from Lansing avoided a $200 fee',
      'Join 50+ homeowners helped this week'
    ];

    // Urgency Messages
    const urgencyMessages = [
      'Wait! Don\'t pay $125+ elsewhere',
      'Limited tech availability today',
      'Only 12 slots left this week',
      'Save money before winter rush',
      'Avoid costly diagnostic fees'
    ];

    let currentSocialProofIndex = 0;
    let currentUrgencyIndex = 0;
    let lastScrollY = window.scrollY;
    let exitIntentShown = false;
    let scrollDirection = 'down';

    // Check if exit intent was already shown today
    const exitIntentShownToday = localStorage.getItem('exitIntentShown') === new Date().toDateString();

    // Progressive CTA based on scroll position
    function updateProgressiveCTA() {
      const scrollY = window.scrollY;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      const scrollPercentage = scrollY / (documentHeight - windowHeight);

      let messageIndex = 0;
      if (scrollPercentage > 0.75) messageIndex = 3; // Bottom of page
      else if (scrollPercentage > 0.5) messageIndex = 2; // Past photo guide
      else if (scrollPercentage > 0.25) messageIndex = 1; // Past hero

      ctaMainText.textContent = progressiveMessages[messageIndex];

      // Track scroll direction for exit intent
      if (scrollY < lastScrollY) {
        scrollDirection = 'up';
      } else {
        scrollDirection = 'down';
      }
      lastScrollY = scrollY;
    }

    // Exit Intent Detection
    function handleExitIntent() {
      if (!exitIntentShown && !exitIntentShownToday && scrollDirection === 'up' && window.scrollY > 300) {
        exitIntentShown = true;
        exitIntentCTA.style.transform = 'translateY(0)';
        progressiveCTA.style.transform = 'translateY(100%)';
        
        // Hide exit intent after 5 seconds
        setTimeout(() => {
          exitIntentCTA.style.transform = 'translateY(100%)';
          progressiveCTA.style.transform = 'translateY(0)';
        }, 5000);

        // Mark as shown today
        localStorage.setItem('exitIntentShown', new Date().toDateString());
      }
    }

    // Rotate Social Proof Messages
    function rotateSocialProof() {
      currentSocialProofIndex = (currentSocialProofIndex + 1) % socialProofMessages.length;
      socialProofText.textContent = socialProofMessages[currentSocialProofIndex];
    }

    // Rotate Urgency Messages
    function rotateUrgency() {
      currentUrgencyIndex = (currentUrgencyIndex + 1) % urgencyMessages.length;
      exitIntentText.textContent = urgencyMessages[currentUrgencyIndex];
    }

    // Event Listeners
    window.addEventListener('scroll', () => {
      updateProgressiveCTA();
      
      // Throttled exit intent check
      setTimeout(handleExitIntent, 100);
    });

    // Rotate messages on timers
    setInterval(rotateSocialProof, 15000); // Every 15 seconds
    setInterval(rotateUrgency, 30000); // Every 30 seconds

    // Initial setup
    updateProgressiveCTA();
    // Import Supabase
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Form elements
    const form = document.getElementById('photo-callback-form');
    const photoInput = document.getElementById('photos');
    const photoPreview = document.getElementById('photo-preview');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitLoading = document.getElementById('submit-loading');

    const phoneInput = document.getElementById('phone');
    const phoneError = document.getElementById('phone-error');

    const addressInput = document.getElementById('address');
    const addressSuggestions = document.getElementById('address-suggestions');

    // Step navigation elements
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const nextStepBtn = document.getElementById('next-step-btn');
    const lastServiceInput = document.getElementById('last_service');

    const formMessages = document.getElementById('form-messages');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const loadingMessage = document.getElementById('loading-message');
    const uploadProgress = document.getElementById('upload-progress');

    let selectedFiles = [];

    // Phone formatting
    function formatPhoneNumber(value) {
      const phone = value.replace(/\D/g, '');
      if (phone.length < 4) return phone;
      if (phone.length < 7) return `(${phone.slice(0,3)}) ${phone.slice(3)}`;
      return `(${phone.slice(0,3)}) ${phone.slice(3,6)}-${phone.slice(6,10)}`;
    }

    function validatePhoneNumber(phone) {
      const digits = phone.replace(/\D/g, '');
      return digits.length === 10;
    }

    phoneInput.addEventListener('input', (e) => {
      const formatted = formatPhoneNumber(e.target.value);
      e.target.value = formatted;

      if (formatted.length > 0) {
        const isValid = validatePhoneNumber(formatted);
        if (!isValid) {
          phoneInput.classList.add('border-red-500');
          phoneError.classList.remove('hidden');
        } else {
          phoneInput.classList.remove('border-red-500');
          phoneError.classList.add('hidden');
        }
      }
    });

    // Address autocomplete functionality
    let debounceTimer;
    let selectedAddressIndex = -1;

    function searchAddresses(query) {
      if (query.length < 3) {
        addressSuggestions.classList.add('hidden');
        return;
      }

      // Debounce API calls
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        try {
          const response = await fetch(
            `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
            `access_token=${MAPBOX_TOKEN}&` +
            `country=US&` +
            `types=address&` +
            `limit=5&` +
            `bbox=-90.418,41.696,-82.413,48.2`  // Michigan bounding box
          );

          if (!response.ok) {
            throw new Error('Address search failed');
          }

          const data = await response.json();
          displayAddressSuggestions(data.features);
        } catch (error) {
          console.error('Address search error:', error);
          addressSuggestions.classList.add('hidden');
        }
      }, 300);
    }

    function displayAddressSuggestions(suggestions) {
      if (suggestions.length === 0) {
        addressSuggestions.classList.add('hidden');
        return;
      }

      addressSuggestions.innerHTML = suggestions.map((suggestion, index) => 
        `<div class="address-suggestion p-3 hover:bg-gray-100 cursor-pointer ${index === selectedAddressIndex ? 'bg-blue-100' : ''}" 
             data-index="${index}" 
             data-address="${suggestion.place_name}">
          ${suggestion.place_name}
        </div>`
      ).join('');

      addressSuggestions.classList.remove('hidden');

      // Add click handlers
      addressSuggestions.querySelectorAll('.address-suggestion').forEach(item => {
        item.addEventListener('click', () => {
          addressInput.value = item.dataset.address;
          addressSuggestions.classList.add('hidden');
          selectedAddressIndex = -1;
        });
      });
    }

    // Address input handlers
    addressInput.addEventListener('input', (e) => {
      searchAddresses(e.target.value);
    });

    addressInput.addEventListener('keydown', (e) => {
      const suggestions = addressSuggestions.querySelectorAll('.address-suggestion');
      
      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedAddressIndex = Math.min(selectedAddressIndex + 1, suggestions.length - 1);
        updateSelectedSuggestion();
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedAddressIndex = Math.max(selectedAddressIndex - 1, -1);
        updateSelectedSuggestion();
      } else if (e.key === 'Enter' && selectedAddressIndex >= 0) {
        e.preventDefault();
        const selectedSuggestion = suggestions[selectedAddressIndex];
        if (selectedSuggestion) {
          addressInput.value = selectedSuggestion.dataset.address;
          addressSuggestions.classList.add('hidden');
          selectedAddressIndex = -1;
        }
      } else if (e.key === 'Escape') {
        addressSuggestions.classList.add('hidden');
        selectedAddressIndex = -1;
      }
    });

    function updateSelectedSuggestion() {
      const suggestions = addressSuggestions.querySelectorAll('.address-suggestion');
      suggestions.forEach((item, index) => {
        if (index === selectedAddressIndex) {
          item.classList.add('bg-blue-100');
          item.classList.remove('bg-gray-100');
        } else {
          item.classList.remove('bg-blue-100');
        }
      });
    }

    // Hide suggestions when clicking outside
    document.addEventListener('click', (e) => {
      if (!addressInput.contains(e.target) && !addressSuggestions.contains(e.target)) {
        addressSuggestions.classList.add('hidden');
        selectedAddressIndex = -1;
      }
    });

    // Photo handling
    function validatePhotos(files) {
      const maxSize = 10 * 1024 * 1024; // 10MB
      const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
      const maxFiles = 6;

      if (files.length > maxFiles) {
        return { valid: false, error: `Maximum ${maxFiles} photos allowed` };
      }

      for (let file of files) {
        if (!allowedTypes.includes(file.type)) {
          return { valid: false, error: 'Only JPEG, PNG, and WebP images are allowed' };
        }
        if (file.size > maxSize) {
          return { valid: false, error: 'Each photo must be under 10MB' };
        }
      }

      return { valid: true };
    }

    function displayPhotoPreview(files) {
      photoPreview.innerHTML = '';
      
      if (files.length > 0) {
        photoPreview.classList.remove('hidden');
      } else {
        photoPreview.classList.add('hidden');
      }
      
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const photoDiv = document.createElement('div');
          photoDiv.className = 'relative bg-gray-100 rounded-lg overflow-hidden';
          photoDiv.innerHTML = `
            <img src="${e.target.result}" alt="Photo ${index + 1}" class="w-full h-32 object-cover">
            <button type="button" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 text-xs hover:bg-red-700" 
                    onclick="removePhoto(${index})">Ã—</button>
            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 text-center">
              Photo ${index + 1}
            </div>
          `;
          photoPreview.appendChild(photoDiv);
        };
        reader.readAsDataURL(file);
      });
    }

    // Make removePhoto globally available
    window.removePhoto = function(index) {
      const dt = new DataTransfer();
      Array.from(selectedFiles).forEach((file, i) => {
        if (i !== index) dt.items.add(file);
      });
      
      selectedFiles = Array.from(dt.files);
      photoInput.files = dt.files;
      displayPhotoPreview(selectedFiles);
      
      if (selectedFiles.length === 0) {
        photoPreview.classList.add('hidden');
      }
      
      // Update next step button
      updateNextStepButton();
    };

    function updateNextStepButton() {
      const hasPhotos = selectedFiles.length > 0;
      const hasLastService = lastServiceInput.value.trim().length > 0;
      
      if (hasPhotos || hasLastService) {
        nextStepBtn.disabled = false;
        nextStepBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        nextStepBtn.classList.add('hover:bg-blue-700');
      } else {
        nextStepBtn.disabled = true;
        nextStepBtn.classList.add('opacity-50', 'cursor-not-allowed');
        nextStepBtn.classList.remove('hover:bg-blue-700');
      }
    }

    // Photo input change handler
    photoInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      const validation = validatePhotos(files);
      
      if (!validation.valid) {
        showMessage('error', validation.error);
        photoInput.value = '';
        selectedFiles = [];
        return;
      }
      
      selectedFiles = files;
      displayPhotoPreview(files);
      hideMessages();
      updateNextStepButton();
    });

    // Last service input handler
    lastServiceInput.addEventListener('change', updateNextStepButton);

    // Step navigation
    nextStepBtn.addEventListener('click', () => {
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
    });

    // Message display functions
    function showMessage(type, text = '') {
      hideMessages();
      formMessages.classList.remove('hidden');
      
      if (type === 'success') {
        successMessage.classList.remove('hidden');
      } else if (type === 'error') {
        errorMessage.classList.remove('hidden');
        if (text) {
          errorText.textContent = text;
        }
      } else if (type === 'loading') {
        loadingMessage.classList.remove('hidden');
      }
    }

    function hideMessages() {
      formMessages.classList.add('hidden');
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      loadingMessage.classList.add('hidden');
    }

    function setLoadingState(loading) {
      submitBtn.disabled = loading;
      if (loading) {
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
      } else {
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      setLoadingState(true);
      showMessage('loading');
      
      try {
        // Get form data
        const formData = new FormData(form);
        const name = formData.get('name')?.trim();
        const phone = formData.get('phone')?.trim();
        const address = formData.get('address')?.trim();
        const lastService = formData.get('last_service')?.trim();
        
        // Validation
        if (!name || !phone) {
          throw new Error('Please fill in all required fields');
        }
        
        if (!validatePhoneNumber(phone)) {
          throw new Error('Please enter a valid phone number');
        }
        
        if (selectedFiles.length === 0 && !lastService) {
          throw new Error('Please upload at least one photo or select when your furnace was last serviced');
        }
        
        let photoUrls = [];
        let uploadedCount = 0;
        
        // Upload photos if any
        if (selectedFiles.length > 0) {
          uploadProgress.innerHTML = '<div class="w-full bg-gray-200 rounded-full h-2.5 mb-4"><div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div><span class="text-sm text-gray-600">Uploading photos... 0%</span>';
          uploadProgress.classList.remove('hidden');
          
          for (let i = 0; i < selectedFiles.length; i++) {
            const file = selectedFiles[i];
            const fileName = `${Date.now()}_${i}_${file.name}`;
            
            try {
              const { data, error } = await supabase.storage
                .from('Furnace Diagnosis Images')
                .upload(fileName, file);
              
              if (error) throw error;
              
              const { data: urlData } = supabase.storage
                .from('Furnace Diagnosis Images')
                .getPublicUrl(fileName);
              
              photoUrls.push(urlData.publicUrl);
              uploadedCount++;
              
              // Update progress
              const progress = Math.round((uploadedCount / selectedFiles.length) * 100);
              uploadProgress.querySelector('.bg-blue-600').style.width = `${progress}%`;
              uploadProgress.querySelector('span').textContent = `Uploading photos... ${progress}%`;
              
            } catch (uploadError) {
              console.error('Photo upload error:', uploadError);
              console.error('Upload error details:', uploadError.message, uploadError.error);
              // Continue with other photos
            }
          }
          
          uploadProgress.classList.add('hidden');
        }
        
        // Save to database
        const { data, error } = await supabase
          .from('form_submissions')
          .insert([
            {
              full_name: name,
              phone_number: phone,
              service_address: address || '',
              last_service: lastService || 'Not specified',
              furnace_issue: 'Photos uploaded for diagnosis',
              photo_count: photoUrls.length,
              photo_urls: photoUrls,
              form_source: 'furnace_diagnosis'
            }
          ]);
        
        if (error) {
          console.error('Database error:', error);
          console.error('Error details:', error.message, error.details, error.hint);
          throw new Error(`Database error: ${error.message}`);
        }
        
        // Success
        setLoadingState(false);
        showMessage('success');
        
        // Track conversion
        if (typeof gtag_report_conversion === 'function') {
          gtag_report_conversion();
        }
        
        form.reset();
        selectedFiles = [];
        photoPreview.innerHTML = '';
        photoPreview.classList.add('hidden');
        
        // Reset to step 1
        step2.classList.add('hidden');
        step1.classList.remove('hidden');
        updateNextStepButton();
        
      } catch (error) {
        console.error('Submission error:', error);
        setLoadingState(false);
        showMessage('error', error.message);
      }
    });

    // Initial setup
    updateNextStepButton();
  });
</script>