---
/**
 * FurnaceDiagnosisScript.astro
 * Contains all the JavaScript functionality for the furnace diagnosis page
 * including progressive CTA, exit intent, form handling, and photo upload
 */

const SUPABASE_URL = import.meta.env.PUBLIC_SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<script is:inline define:vars={{ SUPABASE_URL, SUPABASE_ANON_KEY }}>
  document.addEventListener('DOMContentLoaded', () => {
    // Enhanced CTA System
    const progressiveCTA = document.getElementById('progressive-cta');
    const exitIntentCTA = document.getElementById('exit-intent-cta');
    const ctaMainText = document.getElementById('cta-main-text');
    const socialProofText = document.getElementById('social-proof-text');
    const exitIntentText = document.getElementById('exit-intent-text');

    // Progressive CTA Messages
    const progressiveMessages = [
      'Get Free Analysis',
      'Upload 3 Photos Now',
      'Start Your Upload',
      'Complete Upload'
    ];

    // Social Proof Messages
    const socialProofMessages = [
      'Join 1,200+ homeowners who saved money',
      'Sarah from Ann Arbor just uploaded photos',
      'Mike from Detroit saved $150 today',
      '324 free diagnoses completed this week',
      'Emma from Lansing avoided a $200 fee',
      'Join 50+ homeowners helped this week'
    ];

    // Urgency Messages
    const urgencyMessages = [
      'Wait! Don\'t pay $125+ elsewhere',
      'Limited tech availability today',
      'Only 12 slots left this week',
      'Save money before winter rush',
      'Avoid costly diagnostic fees'
    ];

    let currentSocialProofIndex = 0;
    let currentUrgencyIndex = 0;
    let lastScrollY = window.scrollY;
    let exitIntentShown = false;
    let scrollDirection = 'down';

    // Check if exit intent was already shown today
    const exitIntentShownToday = localStorage.getItem('exitIntentShown') === new Date().toDateString();

    // Progressive CTA based on scroll position
    function updateProgressiveCTA() {
      const scrollY = window.scrollY;
      const windowHeight = window.innerHeight;
      const documentHeight = document.documentElement.scrollHeight;
      const scrollPercentage = scrollY / (documentHeight - windowHeight);

      let messageIndex = 0;
      if (scrollPercentage > 0.75) messageIndex = 3; // Bottom of page
      else if (scrollPercentage > 0.5) messageIndex = 2; // Past photo guide
      else if (scrollPercentage > 0.25) messageIndex = 1; // Past hero

      ctaMainText.textContent = progressiveMessages[messageIndex];

      // Track scroll direction for exit intent
      if (scrollY < lastScrollY) {
        scrollDirection = 'up';
      } else {
        scrollDirection = 'down';
      }
      lastScrollY = scrollY;
    }

    // Exit Intent Detection
    function handleExitIntent() {
      if (!exitIntentShown && !exitIntentShownToday && scrollDirection === 'up' && window.scrollY > 300) {
        exitIntentShown = true;
        exitIntentCTA.style.transform = 'translateY(0)';
        progressiveCTA.style.transform = 'translateY(100%)';
        
        // Hide exit intent after 5 seconds
        setTimeout(() => {
          exitIntentCTA.style.transform = 'translateY(100%)';
          progressiveCTA.style.transform = 'translateY(0)';
        }, 5000);

        // Mark as shown today
        localStorage.setItem('exitIntentShown', new Date().toDateString());
      }
    }

    // Rotate Social Proof Messages
    function rotateSocialProof() {
      currentSocialProofIndex = (currentSocialProofIndex + 1) % socialProofMessages.length;
      socialProofText.textContent = socialProofMessages[currentSocialProofIndex];
    }

    // Rotate Urgency Messages
    function rotateUrgency() {
      currentUrgencyIndex = (currentUrgencyIndex + 1) % urgencyMessages.length;
      exitIntentText.textContent = urgencyMessages[currentUrgencyIndex];
    }

    // Event Listeners
    window.addEventListener('scroll', () => {
      updateProgressiveCTA();
      
      // Throttled exit intent check
      setTimeout(handleExitIntent, 100);
    });

    // Rotate messages on timers
    setInterval(rotateSocialProof, 15000); // Every 15 seconds
    setInterval(rotateUrgency, 30000); // Every 30 seconds

    // Initial setup
    updateProgressiveCTA();

    // Form elements
    const form = document.getElementById('photo-callback-form');
    const photoInput = document.getElementById('photos');
    const photoPreview = document.getElementById('photo-preview');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitLoading = document.getElementById('submit-loading');

    const phoneInput = document.getElementById('phone');
    const phoneError = document.getElementById('phone-error');

    const zipcodeInput = document.getElementById('zipcode');

    // Step navigation elements
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const nextStepBtn = document.getElementById('next-step-btn');
    const lastServiceInput = document.getElementById('last_service');

    const formMessages = document.getElementById('form-messages');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const loadingMessage = document.getElementById('loading-message');
    const uploadProgress = document.getElementById('upload-progress');

    let selectedFiles = [];

    // Phone formatting
    function formatPhoneNumber(value) {
      const phone = value.replace(/\D/g, '');
      if (phone.length < 4) return phone;
      if (phone.length < 7) return `(${phone.slice(0,3)}) ${phone.slice(3)}`;
      return `(${phone.slice(0,3)}) ${phone.slice(3,6)}-${phone.slice(6,10)}`;
    }

    function validatePhoneNumber(phone) {
      const digits = phone.replace(/\D/g, '');
      return digits.length === 10;
    }

    phoneInput.addEventListener('input', (e) => {
      const formatted = formatPhoneNumber(e.target.value);
      e.target.value = formatted;

      if (formatted.length > 0) {
        const isValid = validatePhoneNumber(formatted);
        if (!isValid) {
          phoneInput.classList.add('border-red-500');
          phoneError.classList.remove('hidden');
        } else {
          phoneInput.classList.remove('border-red-500');
          phoneError.classList.add('hidden');
        }
      }
    });

    // ZIP code validation
    function validateZipCode(zipcode) {
      const zipPattern = /^[0-9]{5}$/;
      return zipPattern.test(zipcode);
    }

    zipcodeInput.addEventListener('input', (e) => {
      // Only allow numbers
      e.target.value = e.target.value.replace(/[^0-9]/g, '').slice(0, 5);
      
      // Validate length
      if (e.target.value.length > 0 && !validateZipCode(e.target.value) && e.target.value.length === 5) {
        e.target.classList.add('border-red-500');
      } else {
        e.target.classList.remove('border-red-500');
      }
    });

    // Photo handling
    function validatePhotos(files) {
      const maxSize = 10 * 1024 * 1024; // 10MB
      const allowedTypes = ['image/jpeg', 'image/png', 'image/webp'];
      const maxFiles = 6;

      if (files.length > maxFiles) {
        return { valid: false, error: `Maximum ${maxFiles} photos allowed` };
      }

      for (let file of files) {
        if (!allowedTypes.includes(file.type)) {
          return { valid: false, error: 'Only JPEG, PNG, and WebP images are allowed' };
        }
        if (file.size > maxSize) {
          return { valid: false, error: 'Each photo must be under 10MB' };
        }
      }

      return { valid: true };
    }

    function displayPhotoPreview(files) {
      photoPreview.innerHTML = '';
      
      if (files.length > 0) {
        photoPreview.classList.remove('hidden');
      } else {
        photoPreview.classList.add('hidden');
      }
      
      Array.from(files).forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const photoDiv = document.createElement('div');
          photoDiv.className = 'relative bg-gray-100 rounded-lg overflow-hidden';
          photoDiv.innerHTML = `
            <img src="${e.target.result}" alt="Photo ${index + 1}" class="w-full h-32 object-cover">
            <button type="button" class="absolute top-1 right-1 bg-red-600 text-white rounded-full w-6 h-6 text-xs hover:bg-red-700" 
                    onclick="removePhoto(${index})">Ã—</button>
            <div class="absolute bottom-0 left-0 right-0 bg-black bg-opacity-50 text-white text-xs p-1 text-center">
              Photo ${index + 1}
            </div>
          `;
          photoPreview.appendChild(photoDiv);
        };
        reader.readAsDataURL(file);
      });
    }

    // Make removePhoto globally available
    window.removePhoto = function(index) {
      const dt = new DataTransfer();
      Array.from(selectedFiles).forEach((file, i) => {
        if (i !== index) dt.items.add(file);
      });
      
      selectedFiles = Array.from(dt.files);
      photoInput.files = dt.files;
      displayPhotoPreview(selectedFiles);
      
      if (selectedFiles.length === 0) {
        photoPreview.classList.add('hidden');
      }
      
      // Update next step button
      updateNextStepButton();
    };

    function updateNextStepButton() {
      const hasPhotos = selectedFiles.length > 0;
      const hasLastService = lastServiceInput.value.trim().length > 0;
      
      if (hasPhotos || hasLastService) {
        nextStepBtn.disabled = false;
        nextStepBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        nextStepBtn.classList.add('hover:bg-blue-700');
      } else {
        nextStepBtn.disabled = true;
        nextStepBtn.classList.add('opacity-50', 'cursor-not-allowed');
        nextStepBtn.classList.remove('hover:bg-blue-700');
      }
    }

    // Photo input change handler
    photoInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      const validation = validatePhotos(files);
      
      if (!validation.valid) {
        showMessage('error', validation.error);
        photoInput.value = '';
        selectedFiles = [];
        return;
      }
      
      selectedFiles = files;
      displayPhotoPreview(files);
      hideMessages();
      updateNextStepButton();
    });

    // Last service input handler
    lastServiceInput.addEventListener('change', updateNextStepButton);

    // Step navigation
    nextStepBtn.addEventListener('click', () => {
      step1.classList.add('hidden');
      step2.classList.remove('hidden');
    });

    // Message display functions
    function showMessage(type, text = '') {
      hideMessages();
      formMessages.classList.remove('hidden');
      
      if (type === 'success') {
        successMessage.classList.remove('hidden');
      } else if (type === 'error') {
        errorMessage.classList.remove('hidden');
        if (text) {
          errorText.textContent = text;
        }
      } else if (type === 'loading') {
        loadingMessage.classList.remove('hidden');
      }
    }

    function hideMessages() {
      formMessages.classList.add('hidden');
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      loadingMessage.classList.add('hidden');
    }

    function setLoadingState(loading) {
      submitBtn.disabled = loading;
      if (loading) {
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
      } else {
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      setLoadingState(true);
      showMessage('loading');
      
      try {
        // Get form data
        const formData = new FormData(form);
        const name = formData.get('name')?.trim();
        const phone = formData.get('phone')?.trim();
        const zipcode = formData.get('zipcode')?.trim();
        const lastService = formData.get('last_service')?.trim();
        
        // Validation
        if (!name || !phone || !zipcode) {
          throw new Error('Please fill in all required fields');
        }
        
        if (!validatePhoneNumber(phone)) {
          throw new Error('Please enter a valid phone number');
        }

        if (!validateZipCode(zipcode)) {
          throw new Error('Please enter a valid 5-digit ZIP code');
        }
        
        if (selectedFiles.length === 0 && !lastService) {
          throw new Error('Please upload at least one photo or select when your furnace was last serviced');
        }
        
        let photoUrls = [];
        let uploadedCount = 0;
        
        // Upload photos if any
        if (selectedFiles.length > 0) {
          uploadProgress.innerHTML = '<div class="w-full bg-gray-200 rounded-full h-2.5 mb-4"><div class="bg-blue-600 h-2.5 rounded-full" style="width: 0%"></div></div><span class="text-sm text-gray-600">Uploading photos... 0%</span>';
          uploadProgress.classList.remove('hidden');
          
          try {
            // Create FormData for photo upload
            const photoFormData = new FormData();
            for (let i = 0; i < selectedFiles.length; i++) {
              photoFormData.append('photos', selectedFiles[i]);
            }
            
            // Upload via API endpoint
            const uploadResponse = await fetch('/api/upload-photos', {
              method: 'POST',
              body: photoFormData
            });
            
            if (!uploadResponse.ok) {
              const errorData = await uploadResponse.json();
              throw new Error(errorData.error || 'Photo upload failed');
            }
            
            const uploadResult = await uploadResponse.json();
            if (!uploadResult.success) {
              throw new Error(uploadResult.error || 'Photo upload failed');
            }
            
            photoUrls = uploadResult.photoUrls;
            uploadedCount = uploadResult.uploadedCount;
            
            // Update progress to 100%
            uploadProgress.querySelector('.bg-blue-600').style.width = '100%';
            uploadProgress.querySelector('span').textContent = `Uploaded ${uploadedCount} photos successfully`;
            
            // Show warnings if any uploads failed
            if (uploadResult.warnings && uploadResult.warnings.length > 0) {
              console.warn('Some photo uploads failed:', uploadResult.warnings);
            }
            
          } catch (uploadError) {
            console.error('Photo upload error:', uploadError);
            throw new Error(`Photo upload failed: ${uploadError.message}`);
          }
          
          uploadProgress.classList.add('hidden');
        }
        
        // Save to database via API endpoint
        const submissionPayload = {
          formData: {
            name: name,
            phone: phone,
            address: `ZIP: ${zipcode}`,
            message: lastService || 'Not specified',
            issue: 'Photos uploaded for diagnosis'
          },
          formSource: 'furnace_diagnosis',
          photoUrls: photoUrls,
          photoCount: photoUrls.length
        };

        const submitResponse = await fetch('/api/submit-form', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(submissionPayload)
        });

        if (!submitResponse.ok) {
          const errorData = await submitResponse.json();
          throw new Error(errorData.error || 'Failed to submit form');
        }

        const submissionResult = await submitResponse.json();
        if (!submissionResult.success) {
          throw new Error(submissionResult.error || 'Form submission failed');
        }
        
        // Success
        setLoadingState(false);
        showMessage('success');
        
        // Track conversion
        if (typeof gtag_report_conversion === 'function') {
          gtag_report_conversion();
        }
        
        form.reset();
        selectedFiles = [];
        photoPreview.innerHTML = '';
        photoPreview.classList.add('hidden');
        
        // Reset to step 1
        step2.classList.add('hidden');
        step1.classList.remove('hidden');
        updateNextStepButton();
        
      } catch (error) {
        console.error('Submission error:', error);
        setLoadingState(false);
        showMessage('error', error.message);
      }
    });

    // Initial setup
    updateNextStepButton();
  });
</script>