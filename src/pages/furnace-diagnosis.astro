---
import Layout from "../layouts/Layout.astro";
---

<Layout title="Fix My Furnace Detroit | What's Wrong with Your Furnace?">
  <!-- üî• Hero / Lead Form Section -->
  <section
    class="min-h-screen flex flex-col items-center justify-center bg-gradient-to-br from-red-50 via-white to-gray-50 text-center px-6 pt-16 pb-16"
  >
    <div class="max-w-3xl mx-auto">
      <h1
        id="heroTitle"
        class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4 leading-tight"
      >
        <span class="text-red-600">Instant</span> Furnace
        <span class="underline decoration-red-600">Diagnosis</span>
      </h1>

      <p
        id="heroSubtitle"
        class="text-lg md:text-xl text-gray-700 font-semibold mb-10 max-w-2xl mx-auto"
      >
        Upload photos of your furnace and our expert technicians will diagnose the problem and provide a free estimate - no house call needed.
      </p>
    </div>

    <!-- üßæ Lead Form -->
    <form
      id="leadForm"
      class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-left border border-gray-100"
    >
      <!-- Step 1 -->
      <div id="step1" class="space-y-8">
        <!-- Section 1: Issue Selection -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200 mb-6">
          <label
            class="block font-bold text-gray-800 mb-3 text-sm uppercase tracking-wide"
            >What's happening with your furnace?</label
          >
          <select
            id="issue"
            class="w-full border border-gray-300 rounded-lg p-3 text-base focus:ring-2 focus:ring-red-500 focus:border-red-500"
          >
            <option value="">Select an issue...</option>
            <option>It won't turn on</option>
            <option>It's blowing cold air</option>
            <option>Strange noises</option>
            <option>Old or unreliable</option>
            <option>Not sure</option>
          </select>
        </div>

        <!-- Section 2: Photo Upload -->
        <div class="bg-gray-50 rounded-lg p-4 border border-gray-200">
          <label class="block font-bold text-gray-800 mb-3 text-sm uppercase tracking-wide">
            Upload Photos (Optional but Helpful)
          </label>
          
          <!-- Upload Instructions -->
          <div class="bg-blue-50 border border-blue-200 rounded-lg p-3 mb-4 text-sm">
            <p class="font-medium text-blue-800 mb-2">üì∏ Photo Tips for Faster Service:</p>
            <ul class="text-blue-700 space-y-1 text-xs">
              <li>‚Ä¢ Take photos from multiple angles</li>
              <li>‚Ä¢ Use good lighting (turn on flashlight if needed)</li>
              <li>‚Ä¢ Include close-ups of labels, stickers, or model numbers</li>
              <li>‚Ä¢ Show the overall unit and any problem areas</li>
            </ul>
          </div>

          <!-- File Upload Area -->
          <div 
            id="uploadArea"
            class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-red-500 transition-colors cursor-pointer bg-white"
          >
            <div class="text-gray-500">
              <svg class="mx-auto h-12 w-12 text-gray-400 mb-2" stroke="currentColor" fill="none" viewBox="0 0 48 48">
                <path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8m-12 4h.02" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
              </svg>
              <p class="text-sm font-medium">Click to upload photos or drag and drop</p>
              <p class="text-xs text-gray-400 mt-1">PNG, JPG up to 10MB each</p>
            </div>
            <input 
              type="file" 
              id="photoInput"
              multiple 
              accept="image/*"
              class="hidden"
            />
          </div>

          <!-- Photo Preview Area -->
          <div id="photoPreview" class="mt-3 grid grid-cols-2 gap-2 hidden"></div>
        </div>

        <button
          type="button"
          id="nextStep"
          class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow hover:bg-red-700 active:scale-[0.98] transition"
        >
          Continue
        </button>
      </div>

      <!-- Step 2 -->
      <div id="step2" class="hidden space-y-5">
        <!-- Step 2 Header -->
        <div class="text-center mb-6">
          <h2 class="text-2xl font-bold text-gray-900 mb-2">Almost Done!</h2>
          <p class="text-sm text-gray-600">Our expert technician will review your photos and call you within 24 hours to discuss your furnace issue and provide a free estimate.</p>
        </div>
        <div>
          <label
            for="name"
            class="block font-bold text-gray-800 mb-2 text-sm uppercase tracking-wide"
            >Full Name</label
          >
          <input
            type="text"
            id="name"
            placeholder="Enter your full name"
            class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-red-500 focus:border-red-500 text-base"
          />
        </div>

        <div>
          <label
            for="phone"
            class="block font-bold text-gray-800 mb-2 text-sm uppercase tracking-wide"
            >Phone Number</label
          >
          <input
            type="tel"
            id="phone"
            placeholder="(555) 123-4567"
            class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-red-500 focus:border-red-500 text-base"
          />
        </div>

        <div>
          <label
            for="address"
            class="block font-bold text-gray-800 mb-2 text-sm uppercase tracking-wide"
            >Service Address</label
          >
          <input
            type="text"
            id="address"
            placeholder="Enter your full address"
            class="w-full border border-gray-300 rounded-lg p-3 focus:ring-2 focus:ring-red-500 focus:border-red-500 text-base"
          />
        </div>

        <button
          type="submit"
          class="w-full bg-red-600 text-white font-bold py-3 rounded-lg shadow hover:bg-red-700 active:scale-[0.98] transition"
        >
          Get My Furnace Fixed
        </button>
      </div>

      <!-- Success Message -->
      <div id="successMessage" class="hidden text-center space-y-6">
        <div class="bg-green-50 border border-green-200 rounded-2xl p-8">
          <div class="text-green-600 mb-4">
            <svg class="mx-auto h-16 w-16" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
            </svg>
          </div>
          <h2 class="text-2xl font-bold text-green-800 mb-3">Success! We've Got Your Information</h2>
          <p class="text-green-700 mb-4">
            <span id="photoCount"></span>
          </p>
          <div class="bg-white border border-green-200 rounded-lg p-4 text-left">
            <h3 class="font-bold text-green-800 mb-2">What happens next?</h3>
            <ul class="text-green-700 space-y-1 text-sm">
              <li>‚úì Our expert technician reviews your photos</li>
              <li>‚úì We'll call you within 24 hours</li>
              <li>‚úì Free estimate and problem diagnosis</li>
              <li>‚úì Schedule service if needed</li>
            </ul>
          </div>
        </div>
      </div>
    </form>

    <!-- ‚úÖ Trust Bar -->
    <div
      class="flex flex-wrap justify-center gap-6 mt-10 text-sm md:text-base font-semibold text-gray-700"
    >
      <div class="flex items-center gap-2">
        <i class="text-red-600">üè†</i> Detroit Local
      </div>
      <div class="flex items-center gap-2">
        <i class="text-red-600">üïí</i> Same-Day Service
      </div>
      <div class="flex items-center gap-2">
        <i class="text-red-600">‚úÖ</i> Licensed & Insured
      </div>
    </div>

    <!-- üß≠ Background Accent -->
    <div
      class="absolute inset-0 bg-gradient-to-b from-red-50/20 via-transparent to-gray-50 pointer-events-none -z-10"
    ></div>
  </section>

  <!-- ‚öôÔ∏è Footer -->
  <footer class="bg-gray-900 text-gray-300 text-center text-sm py-6 mt-10">
    <p>¬© 2025 Fix My Furnace Detroit. All rights reserved.</p>
  </footer>
</Layout>

<!-- üß† Script -->
<script>
  import { supabase, STORAGE_BUCKET } from '../lib/supabase.js';
  const nameInput = document.getElementById("name");
  const phoneInput = document.getElementById("phone");
  const addressInput = document.getElementById("address");
  const step1 = document.getElementById("step1");
  const step2 = document.getElementById("step2");
  const nextStep = document.getElementById("nextStep");
  const form = document.getElementById("leadForm");
  const heroTitle = document.getElementById("heroTitle");
  const heroSubtitle = document.getElementById("heroSubtitle");
  const uploadArea = document.getElementById("uploadArea");
  const successMessage = document.getElementById("successMessage");
  const photoCountSpan = document.getElementById("photoCount");
  const photoInput = document.getElementById("photoInput");
  const photoPreview = document.getElementById("photoPreview");
  
  let uploadedFiles = [];

  nextStep.addEventListener("click", () => {
    const issueSelected = document.getElementById("issue").value;
    if (!issueSelected) {
      alert("Please select what's happening with your furnace.");
      return;
    }
    step1.classList.add("hidden");
    step2.classList.remove("hidden");
    
    // Update hero content for Step 2
    heroTitle.innerHTML = '<span class="text-red-600">Get Your</span> Free <span class="underline decoration-red-600">Estimate</span>';
    heroSubtitle.textContent = "Our technician will review your photos and call you within 24 hours to discuss the problem and provide a free estimate.";
  });

  // Photo upload functionality
  uploadArea.addEventListener("click", () => {
    photoInput.click();
  });

  uploadArea.addEventListener("dragover", (e) => {
    e.preventDefault();
    uploadArea.classList.add("border-red-500", "bg-red-50");
  });

  uploadArea.addEventListener("dragleave", (e) => {
    e.preventDefault();
    uploadArea.classList.remove("border-red-500", "bg-red-50");
  });

  uploadArea.addEventListener("drop", (e) => {
    e.preventDefault();
    uploadArea.classList.remove("border-red-500", "bg-red-50");
    const files = e.dataTransfer.files;
    handleFiles(files);
  });

  photoInput.addEventListener("change", (e) => {
    handleFiles(e.target.files);
  });

  function handleFiles(files) {
    Array.from(files).forEach(file => {
      if (file.type.startsWith("image/") && file.size <= 10 * 1024 * 1024) {
        uploadedFiles.push(file);
        createPreview(file);
      } else {
        alert("Please upload images under 10MB only.");
      }
    });
  }

  function createPreview(file) {
    const reader = new FileReader();
    reader.onload = (e) => {
      const preview = document.createElement("div");
      preview.className = "relative group";
      preview.innerHTML = `
        <img src="${e.target.result}" class="w-full h-20 object-cover rounded-lg border">
        <button type="button" onclick="removePhoto(this)" class="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-5 h-5 text-xs flex items-center justify-center hover:bg-red-600">√ó</button>
      `;
      photoPreview.appendChild(preview);
      photoPreview.classList.remove("hidden");
    };
    reader.readAsDataURL(file);
  }

  function removePhoto(button) {
    const preview = button.parentElement;
    const index = Array.from(photoPreview.children).indexOf(preview);
    uploadedFiles.splice(index, 1);
    preview.remove();
    if (uploadedFiles.length === 0) {
      photoPreview.classList.add("hidden");
    }
  }

  // Make removePhoto globally accessible
  window.removePhoto = removePhoto;

  function showSuccessMessage(photoCount) {
    // Hide form steps
    step1.classList.add("hidden");
    step2.classList.add("hidden");
    
    // Update hero content
    heroTitle.innerHTML = '<span class="text-red-600">Thank You!</span> Request <span class="underline decoration-red-600">Submitted</span>';
    heroSubtitle.textContent = "We've received your furnace diagnosis request and will be in touch soon.";
    
    // Update photo count message
    if (photoCount > 0) {
      photoCountSpan.textContent = `Thank you for uploading ${photoCount} photo(s) - this will help our technician provide a more accurate diagnosis.`;
    } else {
      photoCountSpan.textContent = "Our technician will work with the information you provided to help diagnose your furnace issue.";
    }
    
    // Show success message
    successMessage.classList.remove("hidden");
  }

  form.addEventListener("submit", async (e) => {
    e.preventDefault();
    const name = nameInput.value.trim();
    const phone = phoneInput.value.trim();
    const address = addressInput.value.trim();
    const issue = document.getElementById("issue").value;
    
    if (!name) {
      alert("Please enter your full name.");
      return;
    }
    if (!phone) {
      alert("Please enter your phone number.");
      return;
    }
    if (!address) {
      alert("Please enter your service address.");
      return;
    }
    
    // Show loading state
    const submitButton = form.querySelector('button[type="submit"]');
    const originalText = submitButton.textContent;
    submitButton.textContent = "Submitting...";
    submitButton.disabled = true;
    
    try {
      // Upload images to Supabase Storage
      const photoUrls = [];
      for (let i = 0; i < uploadedFiles.length; i++) {
        const file = uploadedFiles[i];
        const fileExt = file.name.split('.').pop();
        const fileName = `${Date.now()}-${i}.${fileExt}`;
        
        const { data, error } = await supabase.storage
          .from(STORAGE_BUCKET)
          .upload(fileName, file);
        
        if (error) {
          console.error('Error uploading file:', error);
          continue;
        }
        
        // Get public URL
        const { data: urlData } = supabase.storage
          .from(STORAGE_BUCKET)
          .getPublicUrl(fileName);
        
        photoUrls.push(urlData.publicUrl);
      }
      
      // Save form data to database
      const { data, error } = await supabase
        .from('form_submissions')
        .insert([
          {
            full_name: name,
            phone_number: phone,
            service_address: address,
            furnace_issue: issue,
            photo_count: uploadedFiles.length,
            photo_urls: photoUrls
          }
        ]);
      
      if (error) {
        console.error('Error saving form:', error);
        alert('There was an error submitting your form. Please try again.');
        return;
      }
      
      // Show success message
      showSuccessMessage(uploadedFiles.length);
      
      // Reset form
      form.reset();
      uploadedFiles = [];
      photoPreview.innerHTML = "";
      photoPreview.classList.add("hidden");
      
    } catch (error) {
      console.error('Submission error:', error);
      alert('There was an error submitting your form. Please try again.');
    } finally {
      // Reset button state
      submitButton.textContent = originalText;
      submitButton.disabled = false;
    }
  });
</script>