---
/**
 * Landing Page 4: Photo Diagnosis Callback Request
 * Upload photos and get expert callback within 24 hours
 */
import Layout from "../layouts/Layout.astro";

const SUPABASE_URL = import.meta.env.SUPABASE_URL;
const SUPABASE_ANON_KEY = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
const MAPBOX_TOKEN = import.meta.env.PUBLIC_MAPBOX_TOKEN;
---

<Layout title="Upload Photos & Get Expert Callback | Fix My Furnace - Michigan">

  <!-- Hero Section -->
  <section class="bg-gradient-to-br from-gray-900 via-blue-900 to-gray-900 text-white py-16 px-6">
    <div class="container mx-auto max-w-5xl text-center">

      <h1 class="text-5xl md:text-6xl font-black mb-6 leading-tight">
        Show Us Your Furnace.<br/>
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-blue-400 via-cyan-400 to-green-400">
          We'll Call You Back.
        </span>
      </h1>

      <p class="text-xl md:text-2xl text-gray-300 mb-8 max-w-3xl mx-auto">
        Upload photos of your furnace, error codes, or problem areas. Our licensed techs will review them and call you within 24 hours with a preliminary assessment.
      </p>

      <div class="flex flex-wrap justify-center gap-6 text-lg">
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <span>100% Free Analysis</span>
        </div>
        <div class="flex items-center gap-3">
          <svg class="w-8 h-8 text-green-400" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
          </svg>
          <span>No Commitment Required</span>
        </div>
      </div>

    </div>
  </section>

  <!-- Form Section -->
  <section class="py-16 px-6 bg-white">
    <div class="container mx-auto max-w-3xl">

      <div class="bg-gradient-to-br from-blue-50 to-cyan-50 rounded-3xl p-8 md:p-12 border-2 border-blue-200">

        <h2 class="text-3xl md:text-4xl font-black text-gray-900 mb-4 text-center">
          Upload Your Photos
        </h2>
        <p class="text-gray-600 text-center mb-8 text-lg">
          Our licensed techs will review them and call you back within 24 hours.
        </p>

        <!-- Success/Error Messages -->
        <div id="form-messages" class="mb-6 hidden">
          <div id="success-message" class="bg-green-50 border-2 border-green-200 rounded-xl p-6 mb-4 hidden">
            <div class="flex items-start gap-4">
              <svg class="w-8 h-8 text-green-600 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
              </svg>
              <div>
                <h4 class="text-green-900 font-bold text-lg mb-1">Photos Uploaded Successfully!</h4>
                <p class="text-green-800">We'll review your photos and call you back within 24 hours. Check your email for confirmation.</p>
              </div>
            </div>
          </div>

          <div id="error-message" class="bg-red-50 border-2 border-red-200 rounded-xl p-6 mb-4 hidden">
            <div class="flex items-start gap-4">
              <svg class="w-8 h-8 text-red-600 flex-shrink-0 mt-1" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z" clip-rule="evenodd"/>
              </svg>
              <div>
                <h4 class="text-red-900 font-bold text-lg mb-1">Submission Failed</h4>
                <p id="error-text" class="text-red-800">Something went wrong. Please try again.</p>
              </div>
            </div>
          </div>

          <div id="loading-message" class="bg-blue-50 border-2 border-blue-200 rounded-xl p-6 mb-4 hidden">
            <div class="flex items-center gap-4">
              <svg class="animate-spin w-8 h-8 text-blue-600" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
              </svg>
              <div>
                <h4 class="text-blue-900 font-bold text-lg mb-1">Uploading Photos...</h4>
                <p id="upload-progress" class="text-blue-800">Please wait while we process your submission.</p>
              </div>
            </div>
          </div>
        </div>

        <form id="photo-callback-form" class="space-y-6">

          <!-- Step 1: Problem Description & Photo Upload -->
          <div id="step1" class="space-y-6">
            <!-- Problem Description -->
            <div>
              <label for="message" class="block text-sm font-bold text-gray-800 mb-2">
                Describe the Problem <span class="text-red-500">*</span>
              </label>
              <textarea
                id="message"
                name="message"
                required
                rows="4"
                placeholder="Tell us what's happening with your furnace... Any error codes? Strange noises? When did it start?"
                class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-gray-800 focus:ring-2 focus:ring-blue-600 focus:border-transparent outline-none transition resize-vertical"
              ></textarea>
            </div>

            <!-- Photo Upload -->
            <div>
              <label for="photos" class="block text-sm font-bold text-gray-800 mb-2">
                Upload Photos <span class="text-red-500">*</span>
              </label>
              <p class="text-sm text-gray-600 mb-3">
                Upload photos of your furnace, error codes, damaged parts, or problem areas. Maximum 5 photos, 10MB each.
              </p>

              <div class="relative">
                <input
                  type="file"
                  id="photos"
                  name="photos"
                  accept="image/jpeg,image/png,image/jpg,image/heic,image/webp"
                  multiple
                  required
                  class="hidden"
                />
                <label
                  for="photos"
                  class="flex flex-col items-center justify-center w-full border-2 border-dashed border-gray-300 rounded-xl px-6 py-12 cursor-pointer hover:border-blue-500 hover:bg-blue-50/50 transition-all"
                >
                  <svg class="w-16 h-16 text-gray-400 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/>
                  </svg>
                  <p class="text-gray-700 font-semibold mb-1">Click to upload photos</p>
                  <p class="text-gray-500 text-sm">or drag and drop</p>
                  <p class="text-gray-400 text-xs mt-2">JPEG, PNG, HEIC up to 10MB each</p>
                </label>
              </div>

              <!-- Photo Preview -->
              <div id="photo-preview" class="mt-4 grid grid-cols-2 sm:grid-cols-3 gap-4 hidden">
                <!-- Preview thumbnails will be inserted here -->
              </div>
            </div>

            <!-- Continue Button -->
            <button
              type="button"
              id="next-step-btn"
              class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-black text-xl py-5 rounded-xl shadow-xl hover:from-blue-700 hover:to-cyan-700 active:scale-[0.98] transition-all"
            >
              Continue
            </button>
          </div>

          <!-- Step 2: Contact Information -->
          <div id="step2" class="hidden space-y-6">
            <!-- Step 2 Header -->
            <div class="text-center mb-6">
              <h3 class="text-2xl font-bold text-gray-900 mb-2">Almost Done!</h3>
              <p class="text-sm text-gray-600">Our expert technicians will review your photos and call you back within 24 hours.</p>
            </div>

            <!-- Name -->
            <div>
              <label for="name" class="block text-sm font-bold text-gray-800 mb-2">
                Full Name <span class="text-red-500">*</span>
              </label>
              <input
                type="text"
                id="name"
                name="name"
                required
                placeholder="Enter your full name"
                class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-gray-800 focus:ring-2 focus:ring-blue-600 focus:border-transparent outline-none transition"
              />
            </div>

            <!-- Phone -->
            <div>
              <label for="phone" class="block text-sm font-bold text-gray-800 mb-2">
                Phone Number <span class="text-red-500">*</span>
              </label>
              <input
                type="tel"
                id="phone"
                name="phone"
                required
                maxlength="14"
                placeholder="(313) 555-1234"
                class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-gray-800 focus:ring-2 focus:ring-blue-600 focus:border-transparent outline-none transition"
              />
              <p id="phone-error" class="text-red-600 text-sm mt-1 hidden">Please enter a valid phone number</p>
            </div>

            <!-- Service Address -->
            <div>
              <label for="address" class="block text-sm font-bold text-gray-800 mb-2">
                Service Address <span class="text-red-500">*</span>
              </label>
              <div class="relative">
                <input
                  type="text"
                  id="address"
                  name="address"
                  required
                  placeholder="Enter your full address"
                  autocomplete="off"
                  class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-gray-800 focus:ring-2 focus:ring-blue-600 focus:border-transparent outline-none transition"
                />
                <!-- Address suggestions dropdown -->
                <div id="address-suggestions" class="absolute z-10 w-full bg-white border border-gray-300 rounded-lg shadow-lg mt-1 hidden max-h-48 overflow-y-auto">
                </div>
              </div>
            </div>

            <!-- Preferred Callback Time -->
            <div>
              <label for="preferredTime" class="block text-sm font-bold text-gray-800 mb-2">
                Preferred Callback Time
              </label>
              <select
                id="preferredTime"
                name="preferredTime"
                class="w-full border-2 border-gray-300 rounded-xl px-4 py-3 text-gray-800 focus:ring-2 focus:ring-blue-600 focus:border-transparent outline-none transition"
              >
                <option value="">Any time works</option>
                <option value="morning">Morning (8am - 12pm)</option>
                <option value="afternoon">Afternoon (12pm - 5pm)</option>
                <option value="evening">Evening (5pm - 8pm)</option>
              </select>
            </div>

            <!-- Submit Button -->
            <button
              type="submit"
              id="submit-btn"
              class="w-full bg-gradient-to-r from-blue-600 to-cyan-600 text-white font-black text-xl py-5 rounded-xl shadow-xl hover:from-blue-700 hover:to-cyan-700 active:scale-[0.98] transition-all disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span id="submit-text">Upload Photos & Request Callback</span>
              <span id="submit-loading" class="hidden">
                <svg class="animate-spin inline w-6 h-6 mr-2" fill="none" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Uploading...
              </span>
            </button>

            <p class="text-sm text-gray-500 text-center">
              By submitting, you agree to receive a callback from Fix My Furnace within 24 hours.
            </p>
          </div>

        </form>

      </div>

    </div>
  </section>

  <!-- What to Photograph Section -->
  <section class="py-16 px-6 bg-gradient-to-br from-gray-50 via-blue-50 to-gray-50">
    <div class="container mx-auto max-w-5xl">

      <h2 class="text-3xl md:text-4xl font-black text-center text-gray-900 mb-12">
        What Should You Photograph?
      </h2>

      <div class="grid md:grid-cols-2 gap-8">

        <div class="bg-white rounded-2xl p-8 shadow-lg">
          <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3">
            <span class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-black">1</span>
            The Control Panel / Thermostat
          </h3>
          <p class="text-gray-600 mb-4">
            Take a clear photo of any error codes, warning lights, or display messages showing on your furnace control panel or thermostat.
          </p>
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <p class="text-sm text-blue-900">
              <strong>ðŸ’¡ Tip:</strong> Error codes are usually the most helpful information for diagnosis!
            </p>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-8 shadow-lg">
          <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3">
            <span class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-black">2</span>
            The Furnace Label / Model Number
          </h3>
          <p class="text-gray-600 mb-4">
            Find the manufacturer label (usually inside the front panel) showing the brand, model number, and age of your system.
          </p>
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <p class="text-sm text-blue-900">
              <strong>ðŸ’¡ Tip:</strong> This helps us order the right parts before we arrive!
            </p>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-8 shadow-lg">
          <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3">
            <span class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-black">3</span>
            Visible Damage or Leaks
          </h3>
          <p class="text-gray-600 mb-4">
            Photograph any rust, water pooling, disconnected wires, broken parts, or anything that looks unusual or damaged.
          </p>
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <p class="text-sm text-blue-900">
              <strong>ðŸ’¡ Tip:</strong> Use your phone's flash for dark basement areas!
            </p>
          </div>
        </div>

        <div class="bg-white rounded-2xl p-8 shadow-lg">
          <h3 class="text-xl font-bold text-gray-900 mb-4 flex items-center gap-3">
            <span class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center text-blue-600 font-black">4</span>
            The Overall Setup
          </h3>
          <p class="text-gray-600 mb-4">
            Take a wide shot showing how your furnace is positioned, how it's connected to ductwork, and the surrounding area.
          </p>
          <div class="bg-blue-50 rounded-lg p-4 border border-blue-200">
            <p class="text-sm text-blue-900">
              <strong>ðŸ’¡ Tip:</strong> This helps us prepare for access and workspace needs!
            </p>
          </div>
        </div>

      </div>

    </div>
  </section>

  <!-- Trust / How It Works -->
  <section class="py-16 px-6 bg-white">
    <div class="container mx-auto max-w-5xl">

      <h2 class="text-3xl md:text-4xl font-black text-center text-gray-900 mb-12">
        What Happens After You Upload?
      </h2>

      <div class="grid md:grid-cols-3 gap-8">

        <div class="text-center">
          <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-cyan-600 rounded-full flex items-center justify-center text-white text-3xl font-black mb-6 mx-auto shadow-xl">
            1
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-3">We Review Your Photos</h3>
          <p class="text-gray-600">
            Our licensed HVAC techs look at your photos and problem description to get a preliminary understanding of the issue.
          </p>
        </div>

        <div class="text-center">
          <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-cyan-600 rounded-full flex items-center justify-center text-white text-3xl font-black mb-6 mx-auto shadow-xl">
            2
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-3">We Call You Back</h3>
          <p class="text-gray-600">
            Within 24 hours, we'll call to discuss what we found, answer questions, and give you a preliminary assessment.
          </p>
        </div>

        <div class="text-center">
          <div class="w-20 h-20 bg-gradient-to-br from-blue-600 to-cyan-600 rounded-full flex items-center justify-center text-white text-3xl font-black mb-6 mx-auto shadow-xl">
            3
          </div>
          <h3 class="text-xl font-bold text-gray-900 mb-3">You Decide Next Steps</h3>
          <p class="text-gray-600">
            We'll explain your options and pricing. If you want to move forward, we'll schedule your $125 home visit.
          </p>
        </div>

      </div>

    </div>
  </section>

  <!-- Sticky Mobile CTA -->
  <div class="md:hidden fixed bottom-0 left-0 right-0 bg-gradient-to-r from-blue-600 to-cyan-600 p-4 shadow-2xl z-50 border-t-4 border-green-400">
    <a href="#photo-callback-form" class="block bg-white text-blue-600 text-center py-4 rounded-xl font-black text-lg shadow-xl">
      Upload Photos Now
    </a>
  </div>

</Layout>

<script is:inline define:vars={{ SUPABASE_URL, SUPABASE_ANON_KEY, MAPBOX_TOKEN }}>
  document.addEventListener('DOMContentLoaded', () => {
    // Import Supabase
    const { createClient } = window.supabase;
    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    // Form elements
    const form = document.getElementById('photo-callback-form');
    const photoInput = document.getElementById('photos');
    const photoPreview = document.getElementById('photo-preview');
    const submitBtn = document.getElementById('submit-btn');
    const submitText = document.getElementById('submit-text');
    const submitLoading = document.getElementById('submit-loading');

    const phoneInput = document.getElementById('phone');
    const phoneError = document.getElementById('phone-error');

    const addressInput = document.getElementById('address');
    const addressSuggestions = document.getElementById('address-suggestions');

    // Step navigation elements
    const step1 = document.getElementById('step1');
    const step2 = document.getElementById('step2');
    const nextStepBtn = document.getElementById('next-step-btn');
    const messageInput = document.getElementById('message');

    const formMessages = document.getElementById('form-messages');
    const successMessage = document.getElementById('success-message');
    const errorMessage = document.getElementById('error-message');
    const errorText = document.getElementById('error-text');
    const loadingMessage = document.getElementById('loading-message');
    const uploadProgress = document.getElementById('upload-progress');

    let selectedFiles = [];

    // Phone formatting
    function formatPhoneNumber(value) {
      const phone = value.replace(/\D/g, '');
      if (phone.length < 4) return phone;
      if (phone.length < 7) return `(${phone.slice(0,3)}) ${phone.slice(3)}`;
      return `(${phone.slice(0,3)}) ${phone.slice(3,6)}-${phone.slice(6,10)}`;
    }

    function validatePhoneNumber(phone) {
      const digits = phone.replace(/\D/g, '');
      return digits.length === 10;
    }

    phoneInput.addEventListener('input', (e) => {
      const formatted = formatPhoneNumber(e.target.value);
      e.target.value = formatted;

      if (formatted.length > 0) {
        const isValid = validatePhoneNumber(formatted);
        if (!isValid) {
          phoneInput.classList.add('border-red-500');
          phoneError.classList.remove('hidden');
        } else {
          phoneInput.classList.remove('border-red-500');
          phoneError.classList.add('hidden');
        }
      }
    });

    // Address autocomplete functionality
    let debounceTimer;
    let selectedAddressIndex = -1;

    function searchAddresses(query) {
      if (query.length < 3) {
        addressSuggestions.classList.add('hidden');
        return;
      }

      // Debounce API calls
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        try {
          const response = await fetch(
            `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
            `access_token=${MAPBOX_TOKEN}&` +
            `country=US&` +
            `types=address&` +
            `limit=5&` +
            `bbox=-90.418,41.696,-82.413,48.2`  // Michigan bounding box
          );

          const data = await response.json();
          displayAddressSuggestions(data.features);
        } catch (error) {
          console.error('Error fetching addresses:', error);
        }
      }, 300);
    }

    function displayAddressSuggestions(addresses) {
      addressSuggestions.innerHTML = '';
      selectedAddressIndex = -1;

      if (addresses.length === 0) {
        addressSuggestions.classList.add('hidden');
        return;
      }

      addresses.forEach((address, index) => {
        const div = document.createElement('div');
        div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-b-0';
        div.textContent = address.place_name;
        div.addEventListener('click', () => selectAddress(address));
        addressSuggestions.appendChild(div);
      });

      addressSuggestions.classList.remove('hidden');
    }

    function selectAddress(address) {
      addressInput.value = address.place_name;
      addressSuggestions.classList.add('hidden');
      selectedAddressIndex = -1;
    }

    // Address input event listeners
    addressInput.addEventListener('input', (e) => {
      searchAddresses(e.target.value);
    });

    addressInput.addEventListener('blur', () => {
      // Delay hiding to allow click events on suggestions
      setTimeout(() => {
        addressSuggestions.classList.add('hidden');
      }, 150);
    });

    addressInput.addEventListener('keydown', (e) => {
      const suggestions = addressSuggestions.querySelectorAll('div');

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedAddressIndex = Math.min(selectedAddressIndex + 1, suggestions.length - 1);
        updateSelectedSuggestion(suggestions);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedAddressIndex = Math.max(selectedAddressIndex - 1, -1);
        updateSelectedSuggestion(suggestions);
      } else if (e.key === 'Enter' && selectedAddressIndex >= 0) {
        e.preventDefault();
        suggestions[selectedAddressIndex].click();
      } else if (e.key === 'Escape') {
        addressSuggestions.classList.add('hidden');
        selectedAddressIndex = -1;
      }
    });

    function updateSelectedSuggestion(suggestions) {
      suggestions.forEach((suggestion, index) => {
        if (index === selectedAddressIndex) {
          suggestion.classList.add('bg-blue-100');
        } else {
          suggestion.classList.remove('bg-blue-100');
        }
      });
    }

    // Step navigation
    nextStepBtn.addEventListener('click', () => {
      // Validate Step 1
      const message = messageInput.value.trim();

      if (!message) {
        alert('Please describe the problem with your furnace.');
        messageInput.focus();
        return;
      }

      if (selectedFiles.length === 0) {
        alert('Please upload at least one photo of your furnace.');
        return;
      }

      // Move to Step 2
      step1.classList.add('hidden');
      step2.classList.remove('hidden');

      // Scroll to top of form
      form.scrollIntoView({ behavior: 'smooth', block: 'start' });
    });

    // Photo preview
    photoInput.addEventListener('change', (e) => {
      const files = Array.from(e.target.files);

      if (files.length > 5) {
        alert('Maximum 5 photos allowed');
        photoInput.value = '';
        return;
      }

      selectedFiles = files;
      displayPhotoPreview(files);
    });

    function displayPhotoPreview(files) {
      photoPreview.innerHTML = '';

      if (files.length === 0) {
        photoPreview.classList.add('hidden');
        return;
      }

      photoPreview.classList.remove('hidden');

      files.forEach((file, index) => {
        const reader = new FileReader();
        reader.onload = (e) => {
          const div = document.createElement('div');
          div.className = 'relative group';
          div.innerHTML = `
            <img src="${e.target.result}" alt="Preview" class="w-full h-32 object-cover rounded-lg border-2 border-gray-200" />
            <button
              type="button"
              data-index="${index}"
              class="remove-photo absolute top-1 right-1 bg-red-500 text-white w-7 h-7 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"
            >
              <svg class="w-4 h-4" fill="currentColor" viewBox="0 0 20 20">
                <path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/>
              </svg>
            </button>
            <p class="text-xs text-gray-600 mt-1 truncate">${file.name}</p>
          `;
          photoPreview.appendChild(div);
        };
        reader.readAsDataURL(file);
      });

      // Remove photo handlers
      setTimeout(() => {
        document.querySelectorAll('.remove-photo').forEach(btn => {
          btn.addEventListener('click', (e) => {
            const index = parseInt(e.currentTarget.dataset.index);
            selectedFiles.splice(index, 1);
            displayPhotoPreview(selectedFiles);

            // Update file input
            const dataTransfer = new DataTransfer();
            selectedFiles.forEach(file => dataTransfer.items.add(file));
            photoInput.files = dataTransfer.files;
          });
        });
      }, 100);
    }

    // Message handlers
    function showMessage(type) {
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      loadingMessage.classList.add('hidden');

      formMessages.classList.remove('hidden');
      if (type === 'success') successMessage.classList.remove('hidden');
      if (type === 'error') errorMessage.classList.remove('hidden');
      if (type === 'loading') loadingMessage.classList.remove('hidden');

      formMessages.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function setLoadingState(loading) {
      submitBtn.disabled = loading;
      if (loading) {
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
      } else {
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    }

    // Form submission
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Validate phone
      if (!validatePhoneNumber(phoneInput.value)) {
        phoneInput.classList.add('border-red-500');
        phoneError.classList.remove('hidden');
        phoneInput.focus();
        return;
      }

      // Validate address
      if (!addressInput.value.trim()) {
        alert('Please enter your service address.');
        addressInput.focus();
        return;
      }

      // Validate photos
      if (selectedFiles.length === 0) {
        alert('Please upload at least one photo');
        return;
      }

      setLoadingState(true);
      showMessage('loading');
      uploadProgress.textContent = 'Uploading photos...';

      try {
        // Upload photos to Supabase Storage
        const photoUrls = [];

        for (let i = 0; i < selectedFiles.length; i++) {
          const file = selectedFiles[i];
          uploadProgress.textContent = `Uploading photo ${i + 1} of ${selectedFiles.length}...`;

          const fileExt = file.name.split('.').pop();
          const fileName = `${Date.now()}-${Math.random().toString(36).substring(7)}.${fileExt}`;
          const filePath = `furnace-photos/${fileName}`;

          const { data, error } = await supabase.storage
            .from('Furnace Diagnosis Images')
            .upload(filePath, file, {
              cacheControl: '3600',
              upsert: false
            });

          if (error) {
            console.error('Upload error:', error);
            throw new Error(`Failed to upload ${file.name}`);
          }

          // Get public URL
          const { data: urlData } = supabase.storage
            .from('Furnace Diagnosis Images')
            .getPublicUrl(filePath);

          photoUrls.push(urlData.publicUrl);
        }

        uploadProgress.textContent = 'Submitting your information...';

        // Submit form data
        const formData = {
          name: document.getElementById('name').value.trim(),
          phone: phoneInput.value.trim(),
          address: addressInput.value.trim(),
          message: document.getElementById('message').value.trim(),
          preferredTime: document.getElementById('preferredTime').value
        };

        const response = await fetch('/api/submit-form', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            formData: formData,
            formSource: 'photo_diagnosis_callback',
            photoUrls: photoUrls,
            photoCount: photoUrls.length
          })
        });

        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.error || 'Failed to submit form');
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'Failed to submit form');
        }

        // Success
        setLoadingState(false);
        showMessage('success');
        form.reset();
        selectedFiles = [];
        photoPreview.innerHTML = '';
        photoPreview.classList.add('hidden');

        // Hide after 10 seconds
        setTimeout(() => {
          formMessages.classList.add('hidden');
        }, 10000);

      } catch (error) {
        console.error('Submission error:', error);
        setLoadingState(false);
        errorText.textContent = error.message || 'Something went wrong. Please try again.';
        showMessage('error');

        setTimeout(() => {
          formMessages.classList.add('hidden');
        }, 7000);
      }
    });
  });
</script>

<!-- Load Supabase JS SDK -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
  /* Add bottom padding on mobile for sticky CTA */
  @media (max-width: 768px) {
    body {
      padding-bottom: 80px;
    }
  }
</style>
</Layout>
