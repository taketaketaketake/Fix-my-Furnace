---
import Layout from "../layouts/Layout.astro";

// Service types for filter dropdown
const serviceTypes = [
  "All Services",
  "Furnace Repair",
  "Furnace Installation",
  "Boiler Repair",
  "Boiler Service",
  "Duct Cleaning",
  "HVAC Maintenance",
  "Air Conditioning Repair",
  "Emergency Service",
  "Other"
];
---

<Layout
  title="HVAC Pricing Transparency | Real Service Costs Michigan"
  description="See real HVAC service costs from Michigan homeowners. Compare furnace repair, installation, and boiler service pricing from actual contracts across Detroit, Grand Rapids, and all of Michigan."
  keywords="HVAC pricing Michigan, furnace repair cost, boiler service price, real service costs, Michigan heating prices"
>
  <!-- ðŸ”¥ HERO -->
  <section class="relative bg-gradient-to-br from-red-50 via-white to-orange-50 py-20 px-6 md:px-10">
    <div class="max-w-7xl mx-auto text-center">
      <h1 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-4 tracking-tight">
        Real Pricing from <span class="text-red-600">Real Michigan Homeowners</span>
      </h1>
      <p class="text-lg md:text-xl font-semibold text-gray-700 max-w-3xl mx-auto">
        See what others actually paid for HVAC services. No guessing, no hidden fees â€” just honest pricing data.
      </p>
    </div>

    <!-- ðŸ”§ Decorative Bar -->
    <div class="absolute bottom-0 left-0 w-full h-2 bg-red-600"></div>
  </section>


  <!-- ðŸ” FILTERS SECTION -->
  <section class="bg-white py-12 px-6 md:px-10">
    <div class="max-w-7xl mx-auto">
      <!-- Search and Filter Row -->
      <div class="flex flex-col lg:flex-row gap-4 items-stretch">
        
        <!-- Service Type Filter -->
        <div class="flex-1">
          <select
            id="filter-service"
            class="w-full px-4 py-4 border-3 border-black rounded-xl text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600 transition-all text-lg bg-white"
          >
            <option value="all">All Services</option>
            {serviceTypes.slice(1).map(type => (
              <option value={type}>
                {type}
              </option>
            ))}
          </select>
        </div>

        <!-- Provider Search -->
        <div class="flex-1">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
            </div>
            <input
              type="text"
              id="filter-provider"
              placeholder="Search by provider name"
              class="w-full pl-12 pr-4 py-4 border-3 border-black rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600 transition-all text-lg"
            />
          </div>
        </div>

        <!-- City Search -->
        <div class="flex-1">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i data-lucide="map-pin" class="h-5 w-5 text-gray-400"></i>
            </div>
            <input
              type="text"
              id="filter-city"
              placeholder="Search by city"
              class="w-full pl-12 pr-4 py-4 border-3 border-black rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600 transition-all text-lg"
            />
          </div>
        </div>


        <!-- Reset Button -->
        <div class="flex-shrink-0">
          <button
            id="clear-filters"
            class="w-full lg:w-auto bg-gray-600 text-white font-semibold px-6 py-4 rounded-xl border-3 border-black hover:bg-gray-700 transition-all text-lg"
          >
            Reset
          </button>
        </div>
      </div>

      <!-- Results Counter & Active Filters -->
      <div class="flex items-center justify-between mt-4">
        <div id="active-filters" class="flex gap-2 flex-wrap">
          <!-- Active filter tags will be added here by JavaScript -->
        </div>
        <div id="results-counter" class="hidden bg-red-50 px-4 py-2 rounded-lg border border-red-200">
          <span class="text-sm font-bold text-red-600">
            <span id="results-count">0</span> results
          </span>
        </div>
      </div>
    </div>
  </section>

  <!-- ðŸ“‹ CONTRACTS TABLE SECTION -->
  <section class="relative bg-white py-16 px-6 md:px-10">
    <div class="max-w-7xl mx-auto">

      <!-- Loading State -->
      <div id="loading-state" class="text-center py-20">
        <i data-lucide="loader-2" class="w-12 h-12 text-red-600 mx-auto mb-4 animate-spin"></i>
        <p class="text-gray-600 font-semibold">Loading pricing data...</p>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-20">
        <i data-lucide="inbox" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
        <p class="text-xl font-bold text-gray-900 mb-2">No Contracts Found</p>
        <p class="text-gray-600 mb-6">Try adjusting your filters or be the first to share pricing data!</p>
        <a
          href="/pricing-insights"
          class="inline-flex items-center gap-2 bg-red-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-red-700 transition-colors"
        >
          <i data-lucide="upload" class="w-5 h-5"></i>
          Share Your Contract
        </a>
      </div>

      <!-- Contracts Table -->
      <div id="contracts-container" class="hidden overflow-x-auto">
        <table class="w-full border-collapse">
          <thead>
            <tr class="bg-gray-100 border-b-2 border-gray-300">
              <th class="text-left py-4 px-4 font-bold text-gray-900">Service Type</th>
              <th class="text-left py-4 px-4 font-bold text-gray-900">Provider</th>
              <th class="text-left py-4 px-4 font-bold text-gray-900">Cost</th>
              <th class="text-left py-4 px-4 font-bold text-gray-900">Location</th>
              <th class="text-left py-4 px-4 font-bold text-gray-900">Date</th>
              <th class="text-left py-4 px-4 font-bold text-gray-900">Details</th>
            </tr>
          </thead>
          <tbody id="contracts-tbody">
            <!-- Rows will be populated by JavaScript -->
          </tbody>
        </table>
      </div>

    </div>
  </section>

  <!-- ðŸ“¤ CTA TO SHARE -->
  <section class="relative bg-gradient-to-br from-red-50 to-orange-50 py-16 px-6 md:px-10">
    <div class="max-w-4xl mx-auto text-center">
      <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4">
        Help Others <span class="text-red-600">Make Informed Decisions</span>
      </h2>
      <p class="text-lg text-gray-700 mb-8">
        Share your service contract to help fellow Michigan homeowners understand fair pricing.
      </p>
      <a
        href="/pricing-insights"
        class="inline-flex items-center gap-2 bg-red-600 text-white font-bold px-8 py-4 rounded-lg hover:bg-red-700 transition-colors text-lg"
      >
        <i data-lucide="upload" class="w-6 h-6"></i>
        Share Your Contract
      </a>
    </div>
  </section>

  <!-- Contract Detail Modal -->
  <div id="contract-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
    <div class="bg-white rounded-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
      <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex justify-between items-center">
        <h3 class="text-2xl font-bold text-gray-900">Contract Details</h3>
        <button id="close-modal" class="text-gray-500 hover:text-gray-700">
          <i data-lucide="x" class="w-6 h-6"></i>
        </button>
      </div>
      <div id="modal-content" class="p-6">
        <!-- Content populated by JavaScript -->
      </div>
    </div>
  </div>

  <!-- Lucide Icons -->
  <script type="module" src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <script>
    // Initialize Lucide icons
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof lucide !== 'undefined') lucide.createIcons();
    });

    // State
    let allContracts = [];
    let currentStats = null;

    // Elements
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const contractsContainer = document.getElementById('contracts-container');
    const contractsTbody = document.getElementById('contracts-tbody');
    const modal = document.getElementById('contract-modal');
    const modalContent = document.getElementById('modal-content');
    const closeModalBtn = document.getElementById('close-modal');

    // Filters
    const filterService = document.getElementById('filter-service') as HTMLSelectElement;
    const filterProvider = document.getElementById('filter-provider') as HTMLInputElement;
    const filterCity = document.getElementById('filter-city') as HTMLInputElement;
    const clearFiltersBtn = document.getElementById('clear-filters');
    const activeFiltersContainer = document.getElementById('active-filters');
    const resultsCounter = document.getElementById('results-counter');
    const resultsCount = document.getElementById('results-count');


    // Fetch contracts on page load
    fetchContracts();

    // Event listeners
    filterService?.addEventListener('change', fetchContracts);
    filterProvider?.addEventListener('input', debounce(fetchContracts, 500));
    filterCity?.addEventListener('input', debounce(fetchContracts, 500));
    clearFiltersBtn?.addEventListener('click', clearFilters);
    closeModalBtn?.addEventListener('click', closeModal);
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) closeModal();
    });

    /**
     * Fetch contracts from API with current filters
     */
    async function fetchContracts() {
      if (!loadingState || !emptyState || !contractsContainer) return;

      // Show loading
      loadingState.classList.remove('hidden');
      emptyState.classList.add('hidden');
      contractsContainer.classList.add('hidden');

      try {
        // Build query params
        const params = new URLSearchParams();

        const service = filterService?.value;
        if (service && service !== 'all') {
          params.append('service', service);
        }

        const provider = filterProvider?.value.trim();
        if (provider) {
          params.append('provider', provider);
        }

        const city = filterCity?.value.trim();
        if (city) {
          params.append('city', city);
        }


        // Fetch data
        const response = await fetch(`/api/get-contracts?${params}`);
        const result = await response.json();

        if (result.success) {
          allContracts = result.contracts;
          currentStats = result.stats;
          renderContracts();
          updateActiveFilters();
          updateResultsCounter();
        } else {
          console.error('Failed to fetch contracts:', result.error);
          showEmptyState();
        }
      } catch (error) {
        console.error('Error fetching contracts:', error);
        showEmptyState();
      } finally {
        loadingState.classList.add('hidden');
      }
    }

    /**
     * Render contracts table
     */
    function renderContracts() {
      if (!contractsTbody || !contractsContainer || !emptyState) return;

      if (allContracts.length === 0) {
        showEmptyState();
        return;
      }

      // Clear existing rows
      contractsTbody.innerHTML = '';

      // Add rows
      allContracts.forEach(contract => {
        const row = document.createElement('tr');
        row.className = 'border-b border-gray-200 hover:bg-gray-50 transition-colors';

        const serviceDate = contract.service_date
          ? new Date(contract.service_date).toLocaleDateString('en-US', { year: 'numeric', month: 'short' })
          : 'N/A';

        const location = contract.city && contract.zip_code
          ? `${contract.city}, ${contract.zip_code}`
          : contract.city || contract.zip_code || 'N/A';

        row.innerHTML = `
          <td class="py-4 px-4">
            <span class="font-semibold text-gray-900">${contract.service_type}</span>
          </td>
          <td class="py-4 px-4 text-gray-700">${contract.provider_name}</td>
          <td class="py-4 px-4">
            <span class="font-bold text-red-600">$${contract.total_cost.toLocaleString()}</span>
          </td>
          <td class="py-4 px-4 text-gray-700">${location}</td>
          <td class="py-4 px-4 text-gray-600 text-sm">${serviceDate}</td>
          <td class="py-4 px-4">
            <button
              class="view-details-btn text-red-600 hover:text-red-700 font-semibold text-sm flex items-center gap-1"
              data-contract-id="${contract.id}"
            >
              <i data-lucide="eye" class="w-4 h-4"></i>
              View
            </button>
          </td>
        `;

        contractsTbody.appendChild(row);
      });

      // Re-initialize Lucide icons for the new content
      if (typeof lucide !== 'undefined') lucide.createIcons();

      // Add click handlers to view buttons
      document.querySelectorAll('.view-details-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const contractId = (e.currentTarget as HTMLElement).getAttribute('data-contract-id');
          showContractDetails(contractId);
        });
      });

      // Show table
      contractsContainer.classList.remove('hidden');
      emptyState.classList.add('hidden');
    }


    /**
     * Show contract details in modal
     */
    function showContractDetails(contractId: string | null) {
      if (!contractId || !modal || !modalContent) return;

      const contract = allContracts.find(c => c.id === contractId);
      if (!contract) return;

      const serviceDate = contract.service_date
        ? new Date(contract.service_date).toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })
        : 'Not specified';

      const location = contract.city && contract.zip_code
        ? `${contract.city}, MI ${contract.zip_code}`
        : contract.city ? `${contract.city}, MI` : 'Not specified';

      modalContent.innerHTML = `
        <div class="space-y-6">
          <!-- Cost -->
          <div class="text-center bg-red-50 rounded-xl p-8 border-2 border-red-200">
            <div class="text-sm font-semibold text-gray-600 mb-2">Total Cost Paid</div>
            <div class="text-5xl font-bold text-red-600">$${contract.total_cost.toLocaleString()}</div>
          </div>

          <!-- Details Grid -->
          <div class="grid md:grid-cols-2 gap-6">
            <div>
              <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">Service Type</h4>
              <p class="text-lg font-semibold text-gray-900">${contract.service_type}</p>
            </div>
            <div>
              <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">Service Provider</h4>
              <p class="text-lg font-semibold text-gray-900">${contract.provider_name}</p>
            </div>
            <div>
              <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">Service Date</h4>
              <p class="text-lg font-semibold text-gray-900">${serviceDate}</p>
            </div>
            <div>
              <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">Location</h4>
              <p class="text-lg font-semibold text-gray-900">${location}</p>
            </div>
          </div>

          ${contract.work_description ? `
            <div>
              <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">Work Performed</h4>
              <p class="text-gray-700">${contract.work_description}</p>
            </div>
          ` : ''}

          <!-- Contract Image -->
          <div>
            <h4 class="text-sm font-bold text-gray-500 uppercase mb-3">Contract/Invoice Image</h4>
            <div class="bg-gray-100 rounded-lg overflow-hidden">
              <img
                src="${contract.contract_image_url}"
                alt="Service contract"
                class="w-full h-auto"
                loading="lazy"
              />
            </div>
            <p class="text-xs text-gray-500 mt-2 text-center">
              Personal information has been reviewed and redacted for privacy
            </p>
          </div>
        </div>
      `;

      modal.classList.remove('hidden');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    /**
     * Close modal
     */
    function closeModal() {
      if (!modal) return;
      modal.classList.add('hidden');
    }

    /**
     * Show empty state
     */
    function showEmptyState() {
      if (!emptyState || !contractsContainer) return;
      emptyState.classList.remove('hidden');
      contractsContainer.classList.add('hidden');
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    /**
     * Update active filters display
     */
    function updateActiveFilters() {
      if (!activeFiltersContainer) return;

      activeFiltersContainer.innerHTML = '';

      const filters = [];

      // Service filter
      if (filterService?.value && filterService.value !== 'all') {
        filters.push({
          label: filterService.value,
          clear: () => {
            filterService.value = 'all';
            fetchContracts();
          }
        });
      }

      // Provider filter
      if (filterProvider?.value.trim()) {
        filters.push({
          label: `Provider: ${filterProvider.value}`,
          clear: () => {
            filterProvider.value = '';
            fetchContracts();
          }
        });
      }

      // City filter
      if (filterCity?.value.trim()) {
        filters.push({
          label: `City: ${filterCity.value}`,
          clear: () => {
            filterCity.value = '';
            fetchContracts();
          }
        });
      }


      // Render filter tags
      filters.forEach(filter => {
        const tag = document.createElement('div');
        tag.className = 'flex items-center gap-2 bg-red-100 text-red-800 px-3 py-1.5 rounded-lg text-sm font-semibold border border-red-200';
        tag.innerHTML = `
          <span>${filter.label}</span>
          <button class="hover:bg-red-200 rounded-full p-0.5 transition-colors">
            <i data-lucide="x" class="w-3 h-3"></i>
          </button>
        `;
        tag.querySelector('button')?.addEventListener('click', filter.clear);
        activeFiltersContainer.appendChild(tag);
      });

      // Re-initialize icons
      if (typeof lucide !== 'undefined') lucide.createIcons();
    }

    /**
     * Update results counter
     */
    function updateResultsCounter() {
      if (!resultsCounter || !resultsCount) return;

      if (allContracts.length > 0) {
        resultsCount.textContent = allContracts.length.toString();
        resultsCounter.classList.remove('hidden');
      } else {
        resultsCounter.classList.add('hidden');
      }
    }

    /**
     * Clear all filters
     */
    function clearFilters() {
      if (filterService) filterService.value = 'all';
      if (filterProvider) filterProvider.value = '';
      if (filterCity) filterCity.value = '';
      fetchContracts();
    }

    /**
     * Debounce utility
     */
    function debounce(func: Function, wait: number) {
      let timeout: number;
      return function executedFunction(...args: any[]) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait) as unknown as number;
      };
    }
  </script>
</Layout>
