---
import Layout from "../../layouts/Layout.astro";

const phoneNumber = import.meta.env.TELNYX_PHONE_NUMBER || '+18334948669';

// Define common Michigan cities and services for filters
const michiganCities = [
  'All Areas',
  'Detroit',
  'Ann Arbor',
  'Grand Rapids',
  'Warren',
  'Sterling Heights',
  'Lansing',
  'Dearborn',
  'Livonia',
  'Flint',
  'Troy',
  'Kalamazoo',
  'Holland',
  'Traverse City',
  'Saginaw',
  'Muskegon',
  'Battle Creek'
];

const services = [
  'All Services',
  'Furnace Repair',
  'Furnace Installation',
  'Boiler Repair',
  'Duct Cleaning',
  'Emergency HVAC',
  'Maintenance',
  'Air Quality'
];
---

<Layout
  title="Find Trusted HVAC Contractors Near You | Michigan Furnace Repair Professionals | Fix My Furnace"
  description="Browse our network of vetted, licensed HVAC contractors across Michigan. Find trusted furnace repair, installation, and heating professionals in Detroit, Grand Rapids, Ann Arbor, Lansing, and all Michigan cities."
  keywords="Michigan HVAC contractors near me, find furnace repair company Michigan, licensed heating contractors Detroit, trusted HVAC professionals Grand Rapids, furnace installation companies Michigan, emergency HVAC service near me"
>
  <!-- Organization/Directory Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "WebPage",
    "name": "Find Trusted HVAC Contractors in Michigan",
    "description": "Directory of vetted, licensed HVAC contractors across Michigan for furnace repair, installation, and heating services",
    "url": "https://fixmyfurnacedetroit.com/partners",
    "mainEntity": {
      "@type": "ItemList",
      "name": "Michigan HVAC Contractors Directory",
      "description": "Vetted network of licensed HVAC professionals across Michigan",
      "numberOfItems": "100+",
      "itemListElement": []
    },
    "breadcrumb": {
      "@type": "BreadcrumbList",
      "itemListElement": [
        {
          "@type": "ListItem",
          "position": 1,
          "name": "Home",
          "item": "https://fixmyfurnacedetroit.com"
        },
        {
          "@type": "ListItem",
          "position": 2,
          "name": "Find HVAC Contractors",
          "item": "https://fixmyfurnacedetroit.com/partners"
        }
      ]
    }
  }
  </script>

  <!-- Local Business Directory Schema -->
  <script type="application/ld+json">
  {
    "@context": "https://schema.org",
    "@type": "Service",
    "name": "HVAC Contractor Directory Service",
    "description": "Connect homeowners with trusted, licensed HVAC contractors across Michigan",
    "provider": {
      "@type": "Organization",
      "name": "Fix My Furnace",
      "url": "https://fixmyfurnacedetroit.com",
      "telephone": "+1-833-494-8669"
    },
    "areaServed": {
      "@type": "State",
      "name": "Michigan"
    },
    "serviceType": [
      "HVAC Contractor Referrals",
      "Furnace Repair Contractor Directory",
      "Heating Installation Professionals",
      "Emergency HVAC Service Providers"
    ]
  }
  </script>
  <!-- ðŸ”¥ HERO -->
  <section class="relative bg-gradient-to-br from-blue-50 via-white to-indigo-50 py-20 px-6 md:px-10">
    <div class="max-w-7xl mx-auto text-center">
      <h1 class="text-4xl md:text-6xl font-extrabold text-gray-900 mb-4 tracking-tight">
        Find <span class="text-red-600">Trusted HVAC Contractors</span> Near You
      </h1>
      <p class="text-lg md:text-xl font-semibold text-gray-700 max-w-3xl mx-auto mb-6">
        Browse our network of vetted, licensed HVAC professionals across Michigan. Every contractor is background-checked, insured, and committed to quality service.
      </p>
      <div class="flex flex-wrap justify-center gap-6 text-gray-800 font-semibold">
        <div class="flex items-center gap-2">
          <i data-lucide="shield-check" class="w-6 h-6 text-green-600"></i>
          <span>Licensed & Insured</span>
        </div>
        <div class="flex items-center gap-2">
          <i data-lucide="star" class="w-6 h-6 text-green-600"></i>
          <span>Background Checked</span>
        </div>
        <div class="flex items-center gap-2">
          <i data-lucide="map-pin" class="w-6 h-6 text-green-600"></i>
          <span>All Michigan Cities</span>
        </div>
        <div class="flex items-center gap-2">
          <i data-lucide="clock" class="w-6 h-6 text-green-600"></i>
          <span>Emergency Available</span>
        </div>
      </div>
    </div>

    <!-- ðŸ”§ Decorative Bar -->
    <div class="absolute bottom-0 left-0 w-full h-2 bg-red-600"></div>
  </section>


  <!-- ðŸ” FILTERS -->
  <section class="bg-white py-12 px-6 md:px-10">
    <div class="max-w-7xl mx-auto">
      <!-- Search and Filter Row -->
      <div class="flex flex-col lg:flex-row gap-4 items-stretch">
        <!-- Search by Name -->
        <div class="flex-1 lg:flex-[2]">
          <div class="relative">
            <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
              <i data-lucide="search" class="h-5 w-5 text-gray-400"></i>
            </div>
            <input
              type="text"
              id="name-search"
              placeholder="Find a contractor by name"
              class="w-full pl-12 pr-4 py-4 border-3 border-black rounded-xl text-gray-900 placeholder-gray-500 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600 transition-all text-lg"
            />
          </div>
        </div>

        <!-- Service Filter -->
        <div class="flex-1">
          <select
            id="service-filter"
            class="w-full px-4 py-4 border-3 border-black rounded-xl text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600 transition-all text-lg bg-white"
          >
            <option value="all">All Services</option>
            {services.slice(1).map(service => (
              <option value={service.toLowerCase()}>
                {service}
              </option>
            ))}
          </select>
        </div>

        <!-- Area Filter -->
        <div class="flex-1">
          <select
            id="area-filter"
            class="w-full px-4 py-4 border-3 border-black rounded-xl text-gray-700 focus:outline-none focus:ring-2 focus:ring-red-600 focus:border-red-600 transition-all text-lg bg-white"
          >
            <option value="all">All Areas</option>
            {michiganCities.slice(1).map(city => (
              <option value={city.toLowerCase()}>
                {city}
              </option>
            ))}
          </select>
        </div>

        <!-- Reset Button -->
        <div class="flex-shrink-0">
          <button
            id="reset-filters"
            class="w-full lg:w-auto bg-gray-600 text-white font-semibold px-6 py-4 rounded-xl border-2 border-black hover:bg-gray-700 transition-all text-lg"
          >
            Reset
          </button>
        </div>
      </div>
    </div>
  </section>

  <!-- ðŸ“‹ PROVIDERS GRID -->
  <section class="bg-gradient-to-br from-gray-50 via-white to-gray-50 py-20 px-6 md:px-10">
    <div class="max-w-7xl mx-auto">
      <!-- Loading State -->
      <div id="loading-state" class="text-center py-12">
        <div class="inline-block">
          <svg class="animate-spin w-12 h-12 text-red-600" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          <p class="mt-4 text-gray-600 font-semibold">Loading our trusted partners...</p>
        </div>
      </div>

      <!-- Empty State -->
      <div id="empty-state" class="hidden text-center py-12">
        <i data-lucide="search" class="w-16 h-16 text-gray-400 mx-auto mb-4"></i>
        <h3 class="text-2xl font-bold text-gray-900 mb-2">No providers found</h3>
        <p class="text-gray-600 mb-6">Try adjusting your filters to see more results.</p>
        <button
          id="reset-empty"
          class="bg-red-600 text-white font-semibold px-6 py-3 rounded-lg hover:bg-red-700 transition"
        >
          Reset Filters
        </button>
      </div>

      <!-- Providers Grid -->
      <div id="providers-grid" class="grid md:grid-cols-2 lg:grid-cols-3 gap-8 hidden">
        <!-- Populated dynamically -->
      </div>
    </div>
  </section>

  <!-- ðŸ’¼ BECOME A PARTNER CTA -->
  <section class="bg-gradient-to-br from-red-50 via-white to-orange-50 py-20 px-6 md:px-10">
    <div class="max-w-4xl mx-auto text-center">
      <h2 class="text-4xl md:text-5xl font-extrabold text-gray-900 mb-6">
        Want to Join Our <span class="text-red-600">Network?</span>
      </h2>
      <p class="text-lg text-gray-700 mb-8 max-w-2xl mx-auto">
        We're always looking for qualified, licensed HVAC professionals to join our trusted network across Michigan.
      </p>
      <a
        href="/partners/apply"
        class="inline-block bg-red-600 text-white font-semibold px-8 py-4 rounded-lg text-lg hover:bg-red-700 transition shadow-lg"
      >
        Apply to Become a Partner
      </a>
    </div>
  </section>


  <!-- Lucide Icons -->
  <script type="module" src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>

  <!-- Providers Directory Script -->
  <script>
    // State
    let allProviders = [];
    let currentFilters = {
      service: 'all',
      area: 'all',
      name: ''
    };

    // DOM Elements
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const providersGrid = document.getElementById('providers-grid');
    const nameSearch = document.getElementById('name-search');
    const serviceFilter = document.getElementById('service-filter');
    const areaFilter = document.getElementById('area-filter');
    const resetButton = document.getElementById('reset-filters');
    const resetEmptyButton = document.getElementById('reset-empty');

    // Fetch providers
    async function fetchProviders() {
      try {
        showLoading();

        const response = await fetch('/api/get-providers');
        const data = await response.json();

        if (data.success) {
          allProviders = data.providers;
          renderProviders(allProviders);
        } else {
          console.error('Failed to fetch providers:', data.error);
          showEmpty();
        }
      } catch (error) {
        console.error('Error fetching providers:', error);
        showEmpty();
      }
    }

    // Show loading state
    function showLoading() {
      loadingState.classList.remove('hidden');
      emptyState.classList.add('hidden');
      providersGrid.classList.add('hidden');
    }

    // Show empty state
    function showEmpty() {
      loadingState.classList.add('hidden');
      emptyState.classList.remove('hidden');
      providersGrid.classList.add('hidden');
    }

    // Show providers
    function showProviders() {
      loadingState.classList.add('hidden');
      emptyState.classList.add('hidden');
      providersGrid.classList.remove('hidden');
    }

    // Filter providers
    function filterProviders() {
      let filtered = allProviders;

      // Filter by name
      if (currentFilters.name.trim() !== '') {
        const searchTerm = currentFilters.name.toLowerCase().trim();
        filtered = filtered.filter(provider =>
          provider.business_name.toLowerCase().includes(searchTerm) ||
          provider.contact_name.toLowerCase().includes(searchTerm)
        );
      }

      // Filter by service
      if (currentFilters.service !== 'all') {
        filtered = filtered.filter(provider =>
          provider.services_offered &&
          provider.services_offered.some(service =>
            service.toLowerCase().includes(currentFilters.service)
          )
        );
      }

      // Filter by area
      if (currentFilters.area !== 'all') {
        filtered = filtered.filter(provider =>
          provider.service_areas &&
          provider.service_areas.some(area =>
            area.toLowerCase().includes(currentFilters.area)
          )
        );
      }

      renderProviders(filtered);
    }

    // Render providers
    function renderProviders(providers) {
      if (!providers || providers.length === 0) {
        showEmpty();
        return;
      }

      providersGrid.innerHTML = providers.map(provider => `
        <div class="bg-white border border-gray-200 rounded-xl shadow-lg p-8 hover:shadow-2xl transition-shadow">
          <!-- Logo or Icon -->
          <div class="mb-6">
            ${provider.logo_url
              ? `<img src="${provider.logo_url}" alt="${provider.business_name}" class="h-16 w-auto object-contain">`
              : `<div class="bg-red-600 w-16 h-16 rounded-full flex items-center justify-center">
                   <i data-lucide="flame" class="w-8 h-8 text-white"></i>
                 </div>`
            }
          </div>

          <!-- Business Name -->
          <h3 class="text-2xl font-bold text-gray-900 mb-3">
            ${provider.business_name}
          </h3>



          <!-- Service Areas -->
          <div class="mb-4">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="map-pin" class="w-4 h-4 text-red-600"></i>
              <span class="text-sm font-bold text-gray-900">Service Areas:</span>
            </div>
            <div class="flex flex-wrap gap-2">
              ${provider.service_areas.slice(0, 4).map(area => `
                <span class="bg-blue-50 text-blue-700 text-sm font-semibold px-3 py-2 rounded-full">
                  ${area}
                </span>
              `).join('')}
              ${provider.service_areas.length > 4
                ? `<span class="bg-blue-50 text-blue-700 text-sm font-semibold px-3 py-2 rounded-full">
                     +${provider.service_areas.length - 4} more
                   </span>`
                : ''
              }
            </div>
          </div>

          <!-- Services Offered -->
          <div class="mb-6">
            <div class="flex items-center gap-2 mb-2">
              <i data-lucide="wrench" class="w-4 h-4 text-red-600"></i>
              <span class="text-sm font-bold text-gray-900">Services:</span>
            </div>
            <div class="flex flex-wrap gap-2">
              ${provider.services_offered.slice(0, 3).map(service => `
                <span class="bg-red-50 text-red-700 text-sm font-semibold px-3 py-2 rounded-full">
                  ${service}
                </span>
              `).join('')}
              ${provider.services_offered.length > 3
                ? `<span class="bg-red-50 text-red-700 text-sm font-semibold px-3 py-2 rounded-full">
                     +${provider.services_offered.length - 3} more
                   </span>`
                : ''
              }
            </div>
          </div>

          <!-- Website Link -->
          ${provider.website
            ? `<a href="${provider.website}" target="_blank" rel="noopener noreferrer" class="inline-flex items-center gap-2 text-red-600 hover:text-red-700 font-semibold transition">
                 <i data-lucide="external-link" class="w-4 h-4"></i>
                 <span>Visit Website</span>
               </a>`
            : ''
          }
        </div>
      `).join('');

      showProviders();

      // Re-initialize Lucide icons for dynamically added content
      if (typeof lucide !== 'undefined') {
        lucide.createIcons();
      }
    }

    // Event listeners
    nameSearch.addEventListener('input', (e) => {
      currentFilters.name = e.target.value;
      filterProviders();
    });

    serviceFilter.addEventListener('change', (e) => {
      currentFilters.service = e.target.value;
      filterProviders();
    });

    areaFilter.addEventListener('change', (e) => {
      currentFilters.area = e.target.value;
      filterProviders();
    });

    resetButton.addEventListener('click', () => {
      currentFilters = { service: 'all', area: 'all', name: '' };
      nameSearch.value = '';
      serviceFilter.value = 'all';
      areaFilter.value = 'all';
      renderProviders(allProviders);
    });

    resetEmptyButton.addEventListener('click', () => {
      currentFilters = { service: 'all', area: 'all', name: '' };
      nameSearch.value = '';
      serviceFilter.value = 'all';
      areaFilter.value = 'all';
      renderProviders(allProviders);
    });

    // Initialize Lucide icons when page loads
    document.addEventListener("DOMContentLoaded", () => {
      if (typeof lucide !== 'undefined') lucide.createIcons();
      fetchProviders();
    });
  </script>
</Layout>
