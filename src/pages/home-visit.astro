---
import Layout from "../layouts/Layout.astro";
---

<Layout
  title="$125 Home Visit Diagnosis | Fix My Furnace Michigan"
  description="Expert HVAC technicians come to your home for just $125 — included in your repair cost. Licensed, insured, and available across Michigan."
  keywords="HVAC diagnosis Michigan, furnace inspection, home heating repair, Fix My Furnace Michigan"
>
  <!-- HERO -->
  <section class="relative bg-gradient-to-br from-red-50 via-white to-orange-50 pt-24 pb-20">
    <div class="container mx-auto px-6 md:px-10 grid md:grid-cols-2 gap-12 items-center">
      <!-- LEFT -->
      <div>
        <div class="inline-flex items-center gap-2 bg-red-100 text-red-800 px-4 py-2 rounded-full text-sm font-semibold mb-6">
          <i data-lucide="home" class="w-4 h-4"></i> Professional Home Assessment
        </div>

        <h1 class="text-5xl md:text-6xl font-extrabold text-gray-900 mb-6 leading-tight text-balance">
          <span class="text-red-600">$125</span> Home Visit<br />
          <span class="text-gray-700">Diagnosis & Expert Repair Credit</span>
        </h1>

        <p class="text-lg md:text-xl text-gray-700 mb-8 leading-relaxed">
          A licensed HVAC technician visits your home, diagnoses your heating issue, and provides clear next steps. 
          <span class="font-semibold text-red-600">Your $125 visit fee is fully credited toward repair work.</span>
        </p>

        <div class="flex flex-col sm:flex-row gap-4 mb-8">
          <a href="#booking" class="bg-red-600 text-white px-8 py-4 rounded-xl font-bold text-lg shadow-lg hover:bg-red-700 hover:scale-[1.02] transition-all text-center">
            Schedule Your Visit
          </a>
          <a href="tel:+18334948669" class="border-2 border-gray-300 text-gray-800 px-8 py-4 rounded-xl font-bold text-lg hover:border-red-600 hover:text-red-600 transition-all text-center">
            Call (833) FIX-IT-NOW
          </a>
        </div>

        <div class="flex flex-wrap gap-6 text-sm text-gray-600">
          <span class="flex items-center gap-2"><i data-lucide="shield-check" class="w-5 h-5 text-red-600"></i> Licensed & Insured</span>
          <span class="flex items-center gap-2"><i data-lucide="clock" class="w-5 h-5 text-red-600"></i> Same-Day Appointments</span>
          <span class="flex items-center gap-2"><i data-lucide="star" class="w-5 h-5 text-red-600"></i> 5-Star Rated Technicians</span>
        </div>
      </div>

      <!-- RIGHT -->
      <div class="relative">
        <div class="relative w-full aspect-[4/3] rounded-2xl overflow-hidden shadow-2xl">
          <img src="/group_photo.png" alt="HVAC technician performing home diagnosis" class="w-full h-full object-cover" />
          <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"></div>
          <div class="absolute top-6 left-6 bg-white rounded-xl p-4 shadow-md">
            <div class="text-2xl font-bold text-red-600">$125</div>
            <div class="text-sm text-gray-600 font-medium">Professional Visit</div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- VALUE SECTION -->
  <section class="py-16 bg-white">
    <div class="container mx-auto px-6 md:px-10">
      <div class="text-center mb-12">
        <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-3">
          What’s Included in Your <span class="text-red-600">$125</span> Visit
        </h2>
        <p class="text-gray-600 text-lg">Comprehensive, professional diagnosis with clear next steps — no guesswork.</p>
      </div>

      <div class="grid md:grid-cols-3 gap-8">
        {[
          {
            icon: "search",
            title: "Complete System Analysis",
            desc: "We inspect your entire heating system for hidden issues — furnace, ducts, thermostat, airflow, and more.",
            bullets: ["Furnace efficiency testing", "Ductwork inspection", "Thermostat calibration"],
          },
          {
            icon: "file-text",
            title: "Written Assessment Report",
            desc: "Get a clear, written summary of findings and transparent repair pricing.",
            bullets: ["Problem identification", "Repair recommendations", "Upfront pricing"],
          },
          {
            icon: "user-check",
            title: "Expert Consultation",
            desc: "Speak directly with a licensed technician who answers all your questions.",
            bullets: ["Licensed technician", "Personalized guidance", "Maintenance tips"],
          },
        ].map((item) => (
          <div class="bg-gray-50 rounded-2xl p-6 border border-gray-100 hover:shadow-xl transition">
            <div class="w-14 h-14 bg-red-100 rounded-xl flex items-center justify-center mb-4">
              <i data-lucide={item.icon} class="w-7 h-7 text-red-600"></i>
            </div>
            <h3 class="text-xl font-bold text-gray-900 mb-3">{item.title}</h3>
            <p class="text-gray-600 mb-3 leading-relaxed">{item.desc}</p>
            <ul class="text-sm text-gray-700 space-y-2">
              {item.bullets.map((b) => (
                <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-red-600"></i> {b}</li>
              ))}
            </ul>
          </div>
        ))}
      </div>
    </div>
  </section>

  <!-- GUARANTEE -->
  <section class="py-16 bg-gray-900 text-white text-center">
    <div class="container mx-auto px-6 max-w-4xl">
      <h2 class="text-3xl md:text-4xl font-extrabold mb-4">$125 Credit Toward Repairs</h2>
      <p class="text-gray-300 text-lg mb-10">
        Move forward with our recommended repair and your diagnostic fee disappears — it’s fully included in the job.
      </p>

      <div class="grid md:grid-cols-2 gap-6 text-left">
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-6">
          <h3 class="text-xl font-bold mb-3 text-red-400">You Pay Only $125 If...</h3>
          <ul class="space-y-2 text-gray-300">
            <li class="flex items-center gap-2"><i data-lucide="x" class="w-4 h-4 text-white"></i> You decline repairs</li>
            <li class="flex items-center gap-2"><i data-lucide="x" class="w-4 h-4 text-white"></i> You use another contractor</li>
            <li class="flex items-center gap-2"><i data-lucide="x" class="w-4 h-4 text-white"></i> No repairs needed</li>
          </ul>
        </div>
        <div class="bg-gray-800 border border-gray-700 rounded-xl p-6">
          <h3 class="text-xl font-bold mb-3 text-green-400">You Pay $0 Extra If...</h3>
          <ul class="space-y-2 text-gray-300">
            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-white"></i> You proceed with repairs</li>
            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-white"></i> Diagnostic fee credited</li>
            <li class="flex items-center gap-2"><i data-lucide="check" class="w-4 h-4 text-white"></i> No hidden costs</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

    <!-- BOOKING CTA -->
    <section id="booking" class="py-20 bg-gray-50">
      <div class="container mx-auto px-6 max-w-3xl">
        <div class="text-center mb-10">
          <h2 class="text-3xl md:text-4xl font-extrabold text-gray-900 mb-3">
            Schedule Your <span class="text-red-600">$125</span> Visit
          </h2>
          <p class="text-gray-600 text-lg">
            Fill out the quick form below — our team will confirm within 2 hours.
          </p>
        </div>
  
        <div class="bg-white rounded-2xl shadow-xl p-6 md:p-8">
          <form id="homeVisitForm" class="space-y-6">
            <!-- Hidden honeypot -->
            <input type="text" name="bot-field" class="hidden" />
  
            <div class="grid md:grid-cols-2 gap-5">
              <div>
                <label for="name" class="block text-sm font-bold text-gray-800 mb-2">Full Name</label>
                <input
                  type="text"
                  id="name"
                  name="name"
                  required
                  placeholder="Enter your full name"
                  class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
                />
              </div>
              <div>
                <label for="phone" class="block text-sm font-bold text-gray-800 mb-2">Phone Number</label>
                <input
                  type="tel"
                  id="phone"
                  name="phone"
                  required
                  placeholder="(833) 494-8669"
                  class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
                />
              </div>
            </div>
  
            <div>
              <label for="email" class="block text-sm font-bold text-gray-800 mb-2">Email Address</label>
              <input
                type="email"
                id="email"
                name="email"
                placeholder="your.email@example.com"
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
              />
            </div>
  
            <div>
              <label for="address" class="block text-sm font-bold text-gray-800 mb-2">Service Address</label>
              <div class="relative">
                <input
                  type="text"
                  id="address"
                  name="address"
                  required
                  placeholder="Enter your full address"
                  autocomplete="off"
                  class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
                />
                <div id="addressSuggestions" class="absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-lg mt-1 hidden max-h-48 overflow-y-auto"></div>
              </div>
            </div>
  
            <div>
              <label for="issue" class="block text-sm font-bold text-gray-800 mb-2">What's the main issue?</label>
              <select
                id="issue"
                name="issue"
                required
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
              >
                <option value="">Select your heating issue...</option>
                <option value="no-heat">No heat at all</option>
                <option value="uneven-heating">Uneven heating throughout home</option>
                <option value="strange-noises">Strange noises from furnace</option>
                <option value="high-bills">High energy bills</option>
                <option value="frequent-cycling">Furnace cycles on/off frequently</option>
                <option value="old-system">System is old/unreliable</option>
                <option value="poor-air-quality">Poor indoor air quality</option>
                <option value="other">Other issue</option>
              </select>
            </div>
  
            <div>
              <label for="preferred-time" class="block text-sm font-bold text-gray-800 mb-2">Preferred Visit Time</label>
              <select
                id="preferred-time"
                name="preferred-time"
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
              >
                <option value="">Any time works</option>
                <option value="morning">Morning (8AM - 12PM)</option>
                <option value="afternoon">Afternoon (12PM - 5PM)</option>
                <option value="evening">Evening (5PM - 8PM)</option>
                <option value="weekend">Weekend availability</option>
              </select>
            </div>
  
            <div>
              <label for="details" class="block text-sm font-bold text-gray-800 mb-2">Additional Details (Optional)</label>
              <textarea
                id="details"
                name="details"
                rows="4"
                placeholder="Any additional information about your system or concerns..."
                class="w-full border border-gray-300 rounded-lg px-4 py-3 text-gray-800 focus:ring-2 focus:ring-red-600 focus:border-transparent outline-none transition"
              ></textarea>
            </div>
  
            <button
              type="submit"
              id="submitBtn"
              class="w-full bg-red-600 text-white font-bold py-4 px-8 rounded-xl text-lg shadow-lg hover:bg-red-700 active:scale-[0.98] transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed"
            >
              <span id="submitText">Schedule My $125 Home Visit</span>
              <span id="submitLoading" class="hidden">
                <i data-lucide="loader-2" class="w-5 h-5 animate-spin inline mr-2"></i>
                Scheduling...
              </span>
            </button>
          </form>
  
          <!-- Success/Error Messages -->
          <div id="formMessages" class="mt-6 hidden">
            <div id="successMessage" class="bg-green-50 border border-green-200 rounded-lg p-4 hidden">
              <div class="flex items-center">
                <i data-lucide="check-circle" class="w-5 h-5 text-green-600 mr-3"></i>
                <p class="text-green-800 font-semibold">Success! We'll contact you within 2 hours to schedule your visit.</p>
              </div>
            </div>
            <div id="errorMessage" class="bg-red-50 border border-red-200 rounded-lg p-4 hidden">
              <div class="flex items-center">
                <i data-lucide="x-circle" class="w-5 h-5 text-red-600 mr-3"></i>
                <p class="text-red-800 font-semibold">Something went wrong. Please try again or call (833) FIX-IT-NOW.</p>
              </div>
            </div>
          </div>
  
          <p class="text-sm text-gray-500 mt-6 text-center">
            By submitting this form, you agree to be contacted by Fix My Furnace for scheduling your home visit.
          </p>
        </div>
      </div>
    </section>
  

  <!-- FINAL CTA -->
  <section class="py-16 bg-red-600 text-white text-center">
    <div class="container mx-auto px-6 max-w-3xl">
      <h2 class="text-3xl md:text-4xl font-extrabold mb-3">Don’t Guess — Get Professional Answers</h2>
      <p class="text-red-100 text-lg mb-8">
        Know exactly what’s wrong with your heating system. Real experts, real answers, same day.
      </p>
      <div class="flex flex-col sm:flex-row gap-4 justify-center">
        <a href="#booking" class="bg-white text-red-600 px-8 py-4 rounded-xl font-bold text-lg hover:bg-gray-100 transition">Book My Visit</a>
        <a href="tel:+18334948669" class="border-2 border-white px-8 py-4 rounded-xl font-bold text-lg hover:bg-white/10 transition">Call (833) FIX-IT-NOW</a>
      </div>
    </div>
  </section>
</Layout>

<!-- Scripts -->
<script type="module" src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
<script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>
<link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

<script type="module">
  // Import Supabase from CDN
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';
  
  document.addEventListener("DOMContentLoaded", () => {
    // Initialize Lucide icons
    if (typeof lucide !== 'undefined') lucide.createIcons();
    
    // Supabase configuration
    const supabaseUrl = 'https://ztvsfapoeekaxztahxsv.supabase.co';
    const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0dnNmYXBvZWVrYXh6dGFoeHN2Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIxMDUzMDIsImV4cCI6MjA3NzY4MTMwMn0.4ff8bfxwEUlJN3JQ3QGsys-xB9Xqu8zUspJSvtzL06k';
    const supabase = createClient(supabaseUrl, supabaseAnonKey);
    
    // Mapbox configuration
    const MAPBOX_TOKEN = 'pk.eyJ1IjoidGFrZS1kZXRyb2l0LXRlY2giLCJhIjoiY21oYms0ODh4MGZpZDJqb2FmcjVkcW1taSJ9.CIimHYrJ3F2r1bJNgREdGA';
    
    // Form elements
    const form = document.getElementById('homeVisitForm');
    const submitBtn = document.getElementById('submitBtn');
    const submitText = document.getElementById('submitText');
    const submitLoading = document.getElementById('submitLoading');
    const successMessage = document.getElementById('successMessage');
    const errorMessage = document.getElementById('errorMessage');
    
    // Address autocomplete elements
    const addressInput = document.getElementById('address');
    const addressSuggestions = document.getElementById('addressSuggestions');

    // Address autocomplete functionality
    let debounceTimer;
    let selectedAddressIndex = -1;

    function searchAddresses(query) {
      if (query.length < 3) {
        addressSuggestions.classList.add('hidden');
        return;
      }

      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(async () => {
        try {
          const response = await fetch(
            `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(query)}.json?` +
            `access_token=${MAPBOX_TOKEN}&` +
            `country=US&` +
            `types=address&` +
            `limit=5&` +
            `bbox=-90.418,41.696,-82.413,48.2`
          );
          
          const data = await response.json();
          displayAddressSuggestions(data.features);
        } catch (error) {
          console.error('Error fetching addresses:', error);
        }
      }, 300);
    }

    function displayAddressSuggestions(addresses) {
      addressSuggestions.innerHTML = '';
      selectedAddressIndex = -1;

      if (addresses.length === 0) {
        addressSuggestions.classList.add('hidden');
        return;
      }

      addresses.forEach((address, index) => {
        const div = document.createElement('div');
        div.className = 'px-3 py-2 hover:bg-gray-100 cursor-pointer text-sm border-b border-gray-100 last:border-b-0';
        div.textContent = address.place_name;
        div.addEventListener('click', () => selectAddress(address));
        addressSuggestions.appendChild(div);
      });

      addressSuggestions.classList.remove('hidden');
    }

    function selectAddress(address) {
      addressInput.value = address.place_name;
      addressSuggestions.classList.add('hidden');
      selectedAddressIndex = -1;
    }

    function updateSelectedSuggestion(suggestions) {
      suggestions.forEach((suggestion, index) => {
        if (index === selectedAddressIndex) {
          suggestion.classList.add('bg-red-100');
        } else {
          suggestion.classList.remove('bg-red-100');
        }
      });
    }

    // Address input event listeners
    if (addressInput && addressSuggestions) {
      addressInput.addEventListener('input', (e) => {
        searchAddresses(e.target.value);
      });

      addressInput.addEventListener('blur', () => {
        setTimeout(() => {
          addressSuggestions.classList.add('hidden');
        }, 150);
      });

      addressInput.addEventListener('keydown', (e) => {
        const suggestions = addressSuggestions.querySelectorAll('div');
        
        if (e.key === 'ArrowDown') {
          e.preventDefault();
          selectedAddressIndex = Math.min(selectedAddressIndex + 1, suggestions.length - 1);
          updateSelectedSuggestion(suggestions);
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          selectedAddressIndex = Math.max(selectedAddressIndex - 1, -1);
          updateSelectedSuggestion(suggestions);
        } else if (e.key === 'Enter' && selectedAddressIndex >= 0) {
          e.preventDefault();
          suggestions[selectedAddressIndex].click();
        } else if (e.key === 'Escape') {
          addressSuggestions.classList.add('hidden');
          selectedAddressIndex = -1;
        }
      });
    }

    // Show/hide messages
    function showMessage(messageType) {
      successMessage.classList.add('hidden');
      errorMessage.classList.add('hidden');
      document.getElementById(messageType + 'Message').classList.remove('hidden');
      document.getElementById(messageType + 'Message').scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }

    function setLoadingState(loading) {
      submitBtn.disabled = loading;
      if (loading) {
        submitText.classList.add('hidden');
        submitLoading.classList.remove('hidden');
      } else {
        submitText.classList.remove('hidden');
        submitLoading.classList.add('hidden');
      }
    }

    // Handle form submission
    if (form) {
      form.addEventListener('submit', async function(e) {
        e.preventDefault();
        
        setLoadingState(true);
        
        try {
          const formData = new FormData(form);
          const name = formData.get('name')?.trim();
          const phone = formData.get('phone')?.trim();
          const email = formData.get('email')?.trim();
          const address = formData.get('address')?.trim();
          const issue = formData.get('issue')?.trim();
          const preferredTime = formData.get('preferred-time')?.trim();
          const details = formData.get('details')?.trim();
          
          // Basic validation
          if (!name || !phone || !address || !issue) {
            throw new Error('Please fill in all required fields');
          }
          
          // Build furnace issue description for database
          let furnaceIssueDescription = issue;
          if (preferredTime) {
            furnaceIssueDescription += ` (Preferred time: ${preferredTime})`;
          }
          if (details) {
            furnaceIssueDescription += ` - Additional details: ${details}`;
          }
          
          // Save to Supabase database using same structure as other forms
          const { data, error } = await supabase
            .from('form_submissions')
            .insert([
              {
                full_name: name,
                phone_number: phone,
                service_address: address,
                furnace_issue: furnaceIssueDescription,
                photo_count: 0,
                photo_urls: [],
                form_source: 'home_visit_landing'
              }
            ]);
          
          if (error) {
            console.error('Error saving form:', error);
            throw new Error('Failed to submit form');
          }
          
          // Success
          setLoadingState(false);
          showMessage('success');
          form.reset();
          
          setTimeout(() => {
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
          }, 7000);
          
        } catch (error) {
          console.error('Submission error:', error);
          setLoadingState(false);
          showMessage('error');
          
          setTimeout(() => {
            successMessage.classList.add('hidden');
            errorMessage.classList.add('hidden');
          }, 7000);
        }
      });
    }

    // Smooth scrolling for anchor links
    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
      anchor.addEventListener('click', function (e) {
        e.preventDefault();
        const target = document.querySelector(this.getAttribute('href'));
        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start'
          });
        }
      });
    });
  });
</script>
