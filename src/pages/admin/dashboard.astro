---
/**
 * Admin Dashboard
 * Simple overview of all business metrics
 * PROTECTED: Requires admin authentication
 */
import Layout from "../../layouts/Layout.astro";
import { supabase } from "../../lib/supabase.js";

// Simple admin protection - check for admin password in URL params
const url = new URL(Astro.request.url);
const adminKey = url.searchParams.get('key');
const ADMIN_KEY = 'hvac2024admin'; // In production, use environment variable

if (adminKey !== ADMIN_KEY) {
  return new Response('Unauthorized', { status: 401 });
}

// Fetch dashboard data
async function getDashboardData() {
  try {
    // Quick stats
    const [
      { count: totalSubmissions },
      { count: todaySubmissions },
      { count: totalContracts },
      { count: activeProviders }
    ] = await Promise.all([
      supabase.from('form_submissions').select('*', { count: 'exact', head: true }),
      supabase.from('form_submissions')
        .select('*', { count: 'exact', head: true })
        .gte('created_at', new Date().toISOString().split('T')[0]),
      supabase.from('service_contracts').select('*', { count: 'exact', head: true }),
      supabase.from('service_providers')
        .select('*', { count: 'exact', head: true })
        .eq('status', 'active')
    ]);

    // Recent form submissions
    const { data: recentSubmissions } = await supabase
      .from('form_submissions')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(10);

    // Form source breakdown
    const { data: formSources } = await supabase
      .from('form_submissions')
      .select('form_source')
      .not('form_source', 'is', null);

    // Recent contracts
    const { data: recentContracts } = await supabase
      .from('service_contracts')
      .select('*')
      .order('created_at', { ascending: false })
      .limit(5);

    // Provider stats
    const { data: providerStats } = await supabase
      .from('service_providers')
      .select('status');

    return {
      stats: {
        totalSubmissions: totalSubmissions || 0,
        todaySubmissions: todaySubmissions || 0,
        totalContracts: totalContracts || 0,
        activeProviders: activeProviders || 0
      },
      recentSubmissions: recentSubmissions || [],
      formSources: formSources || [],
      recentContracts: recentContracts || [],
      providerStats: providerStats || []
    };
  } catch (error) {
    console.error('Dashboard data fetch error:', error);
    return {
      stats: { totalSubmissions: 0, todaySubmissions: 0, totalContracts: 0, activeProviders: 0 },
      recentSubmissions: [],
      formSources: [],
      recentContracts: [],
      providerStats: []
    };
  }
}

const dashboardData = await getDashboardData();

// Process form sources for chart
const formSourceCounts = {};
dashboardData.formSources.forEach(item => {
  const source = item.form_source || 'Unknown';
  formSourceCounts[source] = (formSourceCounts[source] || 0) + 1;
});

// Process provider stats
const providerStatusCounts = {};
dashboardData.providerStats.forEach(item => {
  const status = item.status || 'Unknown';
  providerStatusCounts[status] = (providerStatusCounts[status] || 0) + 1;
});

// Format dates
function formatDate(dateString) {
  return new Date(dateString).toLocaleDateString('en-US', {
    month: 'short',
    day: 'numeric',
    hour: '2-digit',
    minute: '2-digit'
  });
}

// Format currency
function formatCurrency(amount) {
  return new Intl.NumberFormat('en-US', {
    style: 'currency',
    currency: 'USD'
  }).format(amount);
}
---

<Layout title="Admin Dashboard | Fix My Furnace" hideHeader={true} hideTopBanner={true}>

  <!-- Dashboard Header -->
  <section class="bg-gradient-to-r from-gray-900 to-blue-900 text-white py-8 px-6">
    <div class="container mx-auto max-w-7xl">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold mb-2">HVAC Lead Dashboard</h1>
          <p class="text-blue-200">Real-time business metrics and lead management</p>
        </div>
        <div class="text-right">
          <div class="text-sm text-blue-200">Last updated</div>
          <div class="font-semibold" id="last-updated">{new Date().toLocaleTimeString()}</div>
        </div>
      </div>
    </div>
  </section>

  <!-- Quick Stats -->
  <section class="py-8 px-6 bg-gray-50">
    <div class="container mx-auto max-w-7xl">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
        
        <!-- Total Leads -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-600">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Total Leads</p>
              <p class="text-3xl font-bold text-gray-900">{dashboardData.stats.totalSubmissions}</p>
            </div>
            <div class="p-3 bg-blue-100 rounded-full">
              <svg class="w-6 h-6 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Today's Leads -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-600">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">New Today</p>
              <p class="text-3xl font-bold text-gray-900">{dashboardData.stats.todaySubmissions}</p>
            </div>
            <div class="p-3 bg-green-100 rounded-full">
              <svg class="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Contracts -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-600">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Contracts</p>
              <p class="text-3xl font-bold text-gray-900">{dashboardData.stats.totalContracts}</p>
            </div>
            <div class="p-3 bg-purple-100 rounded-full">
              <svg class="w-6 h-6 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Active Providers -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-red-600">
          <div class="flex items-center justify-between">
            <div>
              <p class="text-sm font-medium text-gray-600">Active Providers</p>
              <p class="text-3xl font-bold text-gray-900">{dashboardData.stats.activeProviders}</p>
            </div>
            <div class="p-3 bg-red-100 rounded-full">
              <svg class="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/>
              </svg>
            </div>
          </div>
        </div>

      </div>
    </div>
  </section>

  <!-- Main Content -->
  <section class="py-8 px-6">
    <div class="container mx-auto max-w-7xl">
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

        <!-- Recent Form Submissions (Left - 2/3) -->
        <div class="lg:col-span-2">
          <div class="bg-white rounded-lg shadow-md">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-bold text-gray-900">Recent Form Submissions</h3>
            </div>
            <div class="divide-y divide-gray-200">
              {dashboardData.recentSubmissions.length > 0 ? (
                dashboardData.recentSubmissions.map((submission) => (
                  <div class="px-6 py-4 hover:bg-gray-50 transition-colors">
                    <div class="flex items-center justify-between">
                      <div class="flex-1">
                        <div class="flex items-center gap-3">
                          <h4 class="font-semibold text-gray-900">{submission.full_name}</h4>
                          <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                            {submission.status}
                          </span>
                        </div>
                        <div class="mt-1 text-sm text-gray-600">
                          <span class="mr-4">üìû {submission.phone_number}</span>
                          <span class="mr-4">üè† {submission.service_address?.substring(0, 30)}...</span>
                        </div>
                        <div class="mt-1 text-sm text-gray-500">
                          <span class="mr-4">üìù {submission.furnace_issue}</span>
                          <span>üìç {submission.form_source}</span>
                        </div>
                      </div>
                      <div class="text-right text-sm text-gray-500">
                        {formatDate(submission.created_at)}
                      </div>
                    </div>
                  </div>
                ))
              ) : (
                <div class="px-6 py-8 text-center text-gray-500">
                  No recent submissions found
                </div>
              )}
            </div>
          </div>
        </div>

        <!-- Stats Sidebar (Right - 1/3) -->
        <div class="space-y-6">

          <!-- Form Sources -->
          <div class="bg-white rounded-lg shadow-md">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-bold text-gray-900">Lead Sources</h3>
            </div>
            <div class="p-6">
              {Object.keys(formSourceCounts).length > 0 ? (
                Object.entries(formSourceCounts).map(([source, count]) => (
                  <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-gray-600">{source.replace(/_/g, ' ')}</span>
                    <span class="font-semibold text-gray-900">{count}</span>
                  </div>
                ))
              ) : (
                <p class="text-gray-500 text-sm">No source data available</p>
              )}
            </div>
          </div>

          <!-- Provider Status -->
          <div class="bg-white rounded-lg shadow-md">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-bold text-gray-900">Providers</h3>
            </div>
            <div class="p-6">
              {Object.keys(providerStatusCounts).length > 0 ? (
                Object.entries(providerStatusCounts).map(([status, count]) => (
                  <div class="flex items-center justify-between py-2">
                    <span class="text-sm text-gray-600 capitalize">{status}</span>
                    <span class="font-semibold text-gray-900">{count}</span>
                  </div>
                ))
              ) : (
                <p class="text-gray-500 text-sm">No provider data available</p>
              )}
            </div>
          </div>

          <!-- Recent Contracts -->
          <div class="bg-white rounded-lg shadow-md">
            <div class="px-6 py-4 border-b border-gray-200">
              <h3 class="text-lg font-bold text-gray-900">Recent Contracts</h3>
            </div>
            <div class="divide-y divide-gray-200">
              {dashboardData.recentContracts.length > 0 ? (
                dashboardData.recentContracts.slice(0, 5).map((contract) => (
                  <div class="px-6 py-3">
                    <div class="flex items-center justify-between">
                      <div class="flex-1">
                        <p class="font-semibold text-gray-900">{formatCurrency(contract.total_cost)}</p>
                        <p class="text-sm text-gray-600">{contract.service_type}</p>
                        <p class="text-xs text-gray-500">{contract.city}</p>
                      </div>
                      <span class={`inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
                        contract.status === 'approved' ? 'bg-green-100 text-green-800' :
                        contract.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                        'bg-red-100 text-red-800'
                      }`}>
                        {contract.status}
                      </span>
                    </div>
                  </div>
                ))
              ) : (
                <div class="px-6 py-4 text-center text-gray-500 text-sm">
                  No recent contracts
                </div>
              )}
            </div>
          </div>

        </div>

      </div>
    </div>
  </section>

  <!-- Auto Refresh Script -->
  <script>
    // Auto refresh every 60 seconds
    setInterval(() => {
      window.location.reload();
    }, 60000);

    // Update timestamp
    function updateTimestamp() {
      const timestampEl = document.getElementById('last-updated');
      if (timestampEl) {
        timestampEl.textContent = new Date().toLocaleTimeString();
      }
    }
    
    setInterval(updateTimestamp, 1000);
  </script>

</Layout>